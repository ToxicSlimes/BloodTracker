<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloodTracker</title>
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/ascii-art.css">
    <link rel="stylesheet" href="css/effects.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/modals.css">
    <style>
        @font-face {
            font-family: 'WebPlus IBM MDA';
            src: url('web_ibm_mda.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        :root {
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --primary-color: #00ff00;
            --primary-rgb: 0, 255, 0;
            --border: var(--primary-color);
            --text-primary: var(--primary-color);
            --text-secondary: #00aa00;
            --accent: var(--primary-color);
            --green: var(--primary-color);
            --yellow: #ffff00;
            --red: #ff0000;
            --blue: #00aaff;
            --purple: #aa00ff;
            --glow: 0 0 10px currentColor, 0 0 20px currentColor;
        }
        
        .color-picker-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
        
        .color-picker-toggle {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        
        .color-picker-toggle:hover {
            background: rgba(var(--primary-rgb), 0.1);
            box-shadow: var(--glow);
        }
        
        .color-picker-panel {
            display: none;
            margin-top: 15px;
        }
        
        .color-picker-panel.active {
            display: block;
        }
        
        .color-presets {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .color-preset {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .color-preset:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px currentColor;
        }
        
        .color-custom {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .color-custom input[type="color"] {
            width: 60px;
            height: 40px;
            border: 1px solid var(--border);
            cursor: pointer;
            background: transparent;
        }
        
        .color-custom input[type="text"] {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px;
            font-family: inherit;
            font-size: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'WebPlus IBM MDA', 'VT323', 'Share Tech Mono', 'Courier New', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.3);
            font-size: 18px;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(var(--primary-rgb), 0.03) 2px, rgba(var(--primary-rgb), 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(var(--primary-rgb), 0.03) 2px, rgba(var(--primary-rgb), 0.03) 4px);
            pointer-events: none;
            z-index: 0;
        }
        
        .app {
            position: relative;
            z-index: 1;
            border: 1px solid var(--border);
            margin: 10px;
            box-shadow: 
                0 0 20px rgba(var(--primary-rgb), 0.2),
                inset 0 0 30px rgba(var(--primary-rgb), 0.05);
            background: rgba(0, 0, 0, 0.3);
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5), 0 0 10px rgba(var(--primary-rgb), 0.3); }
            50% { text-shadow: 0 0 10px rgba(var(--primary-rgb), 0.8), 0 0 20px rgba(var(--primary-rgb), 0.5); }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(var(--primary-rgb), 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(var(--primary-rgb), 0.6), 0 0 25px rgba(var(--primary-rgb), 0.4);
            }
        }
        
        @keyframes hoverGlow {
            0%, 100% { 
                box-shadow: 0 0 5px rgba(var(--primary-rgb), 0.2);
                text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.8), 0 0 30px rgba(var(--primary-rgb), 0.5);
                text-shadow: 0 0 15px rgba(var(--primary-rgb), 1), 0 0 25px rgba(var(--primary-rgb), 0.7);
            }
        }
        
        @keyframes activePulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.4), 0 0 20px rgba(var(--primary-rgb), 0.2);
                text-shadow: 0 0 8px rgba(var(--primary-rgb), 0.8), 0 0 15px rgba(var(--primary-rgb), 0.5);
            }
            50% { 
                transform: scale(1.03);
                box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.8), 0 0 35px rgba(var(--primary-rgb), 0.5), 0 0 50px rgba(var(--primary-rgb), 0.3);
                text-shadow: 0 0 15px rgba(var(--primary-rgb), 1), 0 0 25px rgba(var(--primary-rgb), 0.8), 0 0 35px rgba(var(--primary-rgb), 0.5);
            }
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% center;
            }
            100% {
                background-position: 200% center;
            }
        }
        
        @keyframes flex {
            0% { content: 'frame1'; }
            16.66% { content: 'frame2'; }
            33.33% { content: 'frame3'; }
            50% { content: 'frame4'; }
            66.66% { content: 'frame3'; }
            83.33% { content: 'frame2'; }
            100% { content: 'frame1'; }
        }
        
        .ascii-header-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            padding: 15px;
            margin-bottom: 5px;
            position: relative;
        }
        
        .colorful-ascii {
            font-family: 'WebPlus IBM MDA', 'VT323', monospace;
            font-size: 0.5em;
            line-height: 1.0;
            white-space: pre;
            letter-spacing: 0;
            margin: 0;
            padding: 0;
            position: relative;
            display: inline-block;
            color: var(--primary-color);
            text-shadow: 0 0 8px var(--primary-color), 0 0 16px var(--primary-color);
            animation: headerPulse 4s ease-in-out infinite;
        }
        
        .ascii-text {
            font-family: 'WebPlus IBM MDA', 'VT323', monospace;
            white-space: pre;
            line-height: 1.0;
            letter-spacing: 0;
            color: var(--text-primary);
            text-shadow: 0 0 10px currentColor;
            display: block;
            margin: 2px 0;
            padding: 0;
            font-weight: normal;
        }
        
        .ascii-small {
            font-size: 0.4em;
        }
        
        .ascii-medium {
            font-size: 0.5em;
        }
        
        .ascii-large {
            font-size: 0.7em;
        }
        
        button .ascii-text,
        .btn .ascii-text,
        .nav-btn .ascii-text {
            font-size: 0.35em;
        }
        
        h1 .ascii-text,
        h2 .ascii-text,
        h3 .ascii-text {
            font-size: 0.45em;
        }
        
        @keyframes colorShift {
            0%, 100% {
                color: #000000;
                text-shadow: 0 0 5px #000000, 0 0 10px #000000;
            }
            50% {
                color: var(--primary-color);
                text-shadow: 0 0 10px var(--primary-color), 0 0 20px var(--primary-color), 0 0 30px var(--primary-color);
            }
        }
        
        @keyframes typewriter {
            0% { width: 0; }
            100% { width: 100%; }
        }
        
        @keyframes wave {
            0%, 100% { transform: translateY(0); }
            25% { transform: translateY(-3px); }
            75% { transform: translateY(3px); }
        }
        
        @keyframes pulse {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
                filter: brightness(1);
            }
            50% { 
                transform: scale(1.05);
                opacity: 0.9;
                filter: brightness(1.3);
            }
        }
        
        @keyframes glitch {
            0%, 100% { 
                transform: translate(0);
                filter: hue-rotate(0deg);
            }
            20% { 
                transform: translate(-1px, 1px);
                filter: hue-rotate(90deg);
            }
            40% { 
                transform: translate(-1px, -1px);
                filter: hue-rotate(180deg);
            }
            60% { 
                transform: translate(1px, 1px);
                filter: hue-rotate(270deg);
            }
            80% { 
                transform: translate(1px, -1px);
                filter: hue-rotate(360deg);
            }
        }
        
        @keyframes glitchSweepX {
            0% {
                background-position: -200% 0;
            }
            40% {
                background-position: 0 0;
            }
            60% {
                background-position: 0 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        @keyframes glitchText {
            0%, 100% {
                transform: translate(0);
                clip-path: inset(0 0 0 0);
            }
            20% {
                transform: translate(-2px, 2px);
                clip-path: inset(20% 0 60% 0);
            }
            40% {
                transform: translate(-2px, -2px);
                clip-path: inset(60% 0 20% 0);
            }
            60% {
                transform: translate(2px, 2px);
                clip-path: inset(40% 0 40% 0);
            }
            80% {
                transform: translate(2px, -2px);
                clip-path: inset(10% 0 80% 0);
            }
        }
        
        @keyframes glitchNoise {
            0% {
                text-shadow: 0 0 0 rgba(0, 255, 0, 0);
            }
            10%, 20%, 30%, 40%, 50%, 60%, 70%, 80%, 90% {
                text-shadow: 
                    -1px 0 0 rgba(255, 0, 0, 0.8),
                    1px 0 0 rgba(0, 255, 255, 0.8),
                    0 0 10px rgba(0, 255, 0, 0.5);
            }
            100% {
                text-shadow: 0 0 0 rgba(0, 255, 0, 0);
            }
        }
        
        @keyframes glitchMove {
            0%, 100% {
                transform: translateX(0);
                opacity: 1;
            }
            5% {
                transform: translateX(-3px);
                opacity: 0.8;
            }
            10% {
                transform: translateX(3px);
                opacity: 1;
            }
            15% {
                transform: translateX(-2px);
                opacity: 0.9;
            }
            20% {
                transform: translateX(2px);
                opacity: 1;
            }
            25% {
                transform: translateX(0);
                opacity: 0.7;
            }
            30% {
                transform: translateX(-4px);
                opacity: 1;
            }
            35% {
                transform: translateX(4px);
                opacity: 0.8;
            }
            40% {
                transform: translateX(0);
                opacity: 1;
            }
            45% {
                transform: translateX(-2px);
                opacity: 0.9;
            }
            50% {
                transform: translateX(2px);
                opacity: 1;
            }
            55% {
                transform: translateX(0);
                opacity: 0.7;
            }
            60% {
                transform: translateX(-3px);
                opacity: 1;
            }
            65% {
                transform: translateX(3px);
                opacity: 0.8;
            }
            70% {
                transform: translateX(0);
                opacity: 1;
            }
            75% {
                transform: translateX(-2px);
                opacity: 0.9;
            }
            80% {
                transform: translateX(2px);
                opacity: 1;
            }
            85% {
                transform: translateX(0);
                opacity: 0.7;
            }
            90% {
                transform: translateX(-3px);
                opacity: 1;
            }
            95% {
                transform: translateX(3px);
                opacity: 0.8;
            }
        }
        
        @keyframes glitchFlicker {
            0%, 100% {
                opacity: 1;
            }
            41.99% {
                opacity: 1;
            }
            42% {
                opacity: 0;
            }
            43% {
                opacity: 1;
            }
            45.99% {
                opacity: 1;
            }
            46% {
                opacity: 0;
            }
            47% {
                opacity: 1;
            }
            49.99% {
                opacity: 1;
            }
            50% {
                opacity: 0;
            }
            51% {
                opacity: 1;
            }
        }
        
        @keyframes glitchShift {
            0%, 100% {
                clip-path: inset(0 0 0 0);
            }
            20% {
                clip-path: inset(10% 0 20% 0);
            }
            40% {
                clip-path: inset(20% 0 10% 0);
            }
            60% {
                clip-path: inset(5% 0 25% 0);
            }
            80% {
                clip-path: inset(25% 0 5% 0);
            }
        }
        
        @keyframes headerPulse {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 6px var(--primary-color), 0 0 12px var(--primary-color);
            }
            40% {
                opacity: 0.85;
                text-shadow: 0 0 10px var(--primary-color), 0 0 22px var(--primary-color);
            }
            50% {
                opacity: 0.6;
            }
            60% {
                opacity: 0.95;
            }
        }
        
        @keyframes glitchColorShift {
            0%, 100% {
                background-image: linear-gradient(90deg, rgba(0,0,0,0.9) 0%, rgba(0,255,0,0.9) 50%, rgba(0,0,0,0.9) 100%);
            }
            50% {
                background-image: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, rgba(0,255,0,1) 50%, rgba(0,0,0,0.7) 100%);
            }
        }
        
        @keyframes drip {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            5% {
                opacity: 1;
            }
            95% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh - 100px));
                opacity: 0;
            }
        }
        
        @keyframes drip2 {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            8% {
                opacity: 1;
            }
            92% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh - 150px));
                opacity: 0;
            }
        }
        
        @keyframes drip3 {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh - 200px));
                opacity: 0;
            }
        }
        
        @keyframes drip4 {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            12% {
                opacity: 1;
            }
            88% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh - 120px));
                opacity: 0;
            }
        }
        
        @keyframes drip5 {
            0% {
                transform: translateY(0);
                opacity: 0;
            }
            7% {
                opacity: 1;
            }
            93% {
                opacity: 1;
            }
            100% {
                transform: translateY(calc(100vh - 180px));
                opacity: 0;
            }
        }
        
        .glitch-text {
            position: relative;
            animation: glitchText 0.3s infinite;
        }
        
        .glitch-text::before,
        .glitch-text::after {
            content: attr(data-text);
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .glitch-text::before {
            animation: glitchNoise 0.3s infinite;
            clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
            transform: translate(-2px, -2px);
            color: rgba(255, 0, 0, 0.8);
            z-index: -1;
        }
        
        .glitch-text::after {
            animation: glitchNoise 0.3s infinite reverse;
            clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
            transform: translate(2px, 2px);
            color: rgba(0, 255, 255, 0.8);
            z-index: -1;
        }
        
        .glitch-enhanced {
            position: relative;
            color: var(--primary-color);
            text-shadow: 0 0 6px var(--primary-color), 0 0 14px var(--primary-color);
            animation: headerPulse 4s ease-in-out infinite;
        }
        
        .spark {
            position: fixed;
            color: var(--primary-color);
            opacity: 1;
            font-size: 0.8em;
            font-weight: bold;
            text-shadow: 0 0 5px var(--primary-color), 0 0 10px var(--primary-color), 0 0 15px var(--primary-color);
            pointer-events: none;
            z-index: 9999;
            will-change: transform, opacity;
            transition: opacity 0.1s linear;
        }
        
        .spark.fading {
            opacity: 0;
        }
        
        .spark-glow {
            position: fixed;
            color: var(--primary-color);
            font-family: 'WebPlus IBM MDA', 'VT323', monospace;
            font-size: 0.6em;
            text-shadow: 0 0 2px var(--primary-color);
            opacity: 0.6;
            pointer-events: none;
            z-index: 10000;
            animation: pixelFlicker 0.3s ease-out forwards;
        }
        
        @keyframes pixelFlicker {
            0% {
                opacity: 0;
            }
            20% {
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
            80% {
                opacity: 0.6;
            }
            100% {
                opacity: 0;
            }
        }
        
        .drip:nth-child(2) {
            animation-delay: 0.4s;
            animation-name: drip2;
        }
        
        .drip:nth-child(3) {
            animation-delay: 0.8s;
            animation-name: drip3;
        }
        
        .drip:nth-child(4) {
            animation-delay: 1.2s;
            animation-name: drip4;
        }
        
        .drip:nth-child(5) {
            animation-delay: 1.6s;
            animation-name: drip5;
        }
        
        .drip:nth-child(6) {
            animation-delay: 2.0s;
            animation-name: drip;
        }
        
        .drip:nth-child(7) {
            animation-delay: 2.4s;
            animation-name: drip2;
        }
        
        .drip:nth-child(8) {
            animation-delay: 2.8s;
            animation-name: drip3;
        }
        
        .drip:nth-child(9) {
            animation-delay: 3.2s;
            animation-name: drip4;
        }
        
        .drip:nth-child(10) {
            animation-delay: 3.6s;
            animation-name: drip5;
        }
        
        .ascii-skull-container {
            position: relative;
            display: inline-block;
            font-family: 'WebPlus IBM MDA', 'VT323', monospace;
            font-size: 1.0em;
            line-height: 1.0;
            white-space: pre;
            color: var(--green);
            text-shadow: 0 0 10px var(--green);
        }
        
        @keyframes rainbow {
            0% { 
                color: #ff0000;
                text-shadow: 0 0 10px #ff0000;
            }
            16.66% { 
                color: #ff7f00;
                text-shadow: 0 0 10px #ff7f00;
            }
            33.33% { 
                color: #ffff00;
                text-shadow: 0 0 10px #ffff00;
            }
            50% { 
                color: #00ff00;
                text-shadow: 0 0 10px #00ff00;
            }
            66.66% { 
                color: #0000ff;
                text-shadow: 0 0 10px #0000ff;
            }
            83.33% { 
                color: #4b0082;
                text-shadow: 0 0 10px #4b0082;
            }
            100% { 
                color: #9400d3;
                text-shadow: 0 0 10px #9400d3;
            }
        }
        
        @keyframes slideUp {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }
            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes matrix {
            0% {
                text-shadow: 0 0 5px currentColor;
                filter: blur(0px);
            }
            50% {
                text-shadow: 0 0 15px currentColor, 0 0 25px currentColor;
                filter: blur(1px);
            }
            100% {
                text-shadow: 0 0 5px currentColor;
                filter: blur(0px);
            }
        }
        
        @keyframes rotate3d {
            0%, 100% {
                transform: perspective(500px) rotateY(0deg) rotateX(0deg);
            }
            25% {
                transform: perspective(500px) rotateY(5deg) rotateX(2deg);
            }
            50% {
                transform: perspective(500px) rotateY(0deg) rotateX(0deg);
            }
            75% {
                transform: perspective(500px) rotateY(-5deg) rotateX(-2deg);
            }
        }
        
        .ascii-animate-wave {
            animation: wave 2s ease-in-out infinite;
        }
        
        .ascii-animate-wave pre {
            display: inline-block;
            animation: wave 2s ease-in-out infinite;
        }
        
        .ascii-animate-wave pre {
            animation-delay: calc(var(--char-index, 0) * 0.1s);
        }
        
        .ascii-animate-pulse {
            animation: pulse 2s ease-in-out infinite;
        }
        
        .ascii-animate-glitch {
            animation: glitch 0.3s infinite;
        }
        
        .ascii-animate-rainbow {
            animation: rainbow 3s linear infinite;
        }
        
        .ascii-animate-slide-up {
            animation: slideUp 0.8s ease-out;
        }
        
        .ascii-animate-matrix {
            animation: matrix 2s ease-in-out infinite;
        }
        
        .ascii-animate-rotate3d {
            animation: rotate3d 4s ease-in-out infinite;
        }
        
        .ascii-animate-combo {
            animation: pulse 2s ease-in-out infinite, matrix 2s ease-in-out infinite;
        }
        
        .nav-btn:hover .ascii-text,
        .btn:hover .ascii-text {
            animation: pulse 0.5s ease-in-out;
        }
        
        .card-title:hover .ascii-text {
            animation: wave 1s ease-in-out;
        }
        
        .stat-value:hover .ascii-text {
            animation: pulse 1s ease-in-out infinite, matrix 1s ease-in-out infinite;
        }
        
        .logo:hover .colorful-ascii {
            animation: glitch 0.5s ease-in-out, rainbow 2s linear infinite;
        }
        
        @keyframes scanline {
            0% {
                transform: translateY(-100%);
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                transform: translateY(100%);
                opacity: 0;
            }
        }
        
        .ascii-animate-scanline {
            position: relative;
            overflow: hidden;
        }
        
        .ascii-animate-scanline::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-color);
            box-shadow: 0 0 10px var(--primary-color);
            animation: scanline 2s linear infinite;
            z-index: 10;
            pointer-events: none;
        }
        
        @keyframes flicker {
            0%, 100% { opacity: 1; }
            41.99% { opacity: 1; }
            42% { opacity: 0; }
            42.01% { opacity: 1; }
            42.5% { opacity: 0; }
            43% { opacity: 1; }
            43.5% { opacity: 0; }
            44% { opacity: 1; }
            44.5% { opacity: 0; }
            45% { opacity: 1; }
        }
        
        .ascii-animate-flicker {
            animation: flicker 3s infinite;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-1px); }
            20%, 40%, 60%, 80% { transform: translateX(1px); }
        }
        
        .ascii-animate-shake {
            animation: shake 0.5s ease-in-out infinite;
        }
        
        .nav-btn.active .ascii-text,
        .tab.active .ascii-text {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .card:hover .card-title .ascii-text {
            animation: wave 1s ease-in-out, pulse 2s ease-in-out infinite;
        }
        
        .cursor::after {
            content: '_';
            animation: blink 1s infinite;
            color: var(--primary-color);
        }
        
        .app { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.4);
            margin-bottom: 0;
            box-shadow: 
                0 2px 10px rgba(var(--primary-rgb), 0.15),
                inset 0 -1px 0 rgba(var(--primary-rgb), 0.1);
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        
        .header-content::after {
            content: '════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════════ ASCII разделитель
            color: var(--primary-color);
            font-family: 'WebPlus IBM MDA', 'VT323', monospace;
            font-size: 0.4em;
            opacity: 0.6;
            margin: 5px 0;
            text-align: center;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
        }
        
        @media (max-width: 768px) {
            header {
                padding: 15px 0;
            }
        }
        
        .logo { 
            font-weight: 400; 
            color: var(--primary-color);
            text-shadow: var(--glow);
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        .logo span { color: var(--primary-color); }
        
        .ascii-art {
            font-family: 'WebPlus IBM MDA', 'VT323', monospace;
            font-size: 0.25em;
            line-height: 1.0;
            color: var(--primary-color);
            text-shadow: 0 0 8px currentColor;
            white-space: pre;
            letter-spacing: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        @media (max-width: 768px) {
            .ascii-art {
                font-size: 0.15em;
            }
            .flex-container {
                display: none;
            }
        }
        
        nav { 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            justify-content: center;
            margin-top: 5px;
            padding: 10px 0;
        }
        
        .nav-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            text-shadow: 0 0 5px var(--primary-color);
        }
        
        .nav-btn::before {
            content: '> ';
            opacity: 0;
            transition: opacity 0.2s;
            width: 0;
            display: inline-block;
        }
        
        .nav-btn:hover::before,
        .nav-btn.active::before {
            opacity: 1;
            width: auto;
        }
        
        .nav-btn:hover { 
            background: rgba(var(--primary-rgb, 0, 255, 0), 0.1); 
            box-shadow: var(--glow);
            text-shadow: var(--glow);
            animation: hoverGlow 1.5s ease-in-out infinite;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .nav-btn.active { 
            background: rgba(var(--primary-rgb, 0, 255, 0), 0.2); 
            box-shadow: var(--glow);
            text-shadow: var(--glow);
            color: var(--primary-color);
            animation: activePulse 2s ease-in-out infinite;
            position: relative;
        }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .card {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
            box-shadow: 
                0 0 10px rgba(var(--primary-rgb), 0.15),
                inset 0 0 15px rgba(var(--primary-rgb), 0.03);
        }
        
        .card::before {
            content: '┌';
            position: absolute;
            top: -1px;
            left: -1px;
            color: var(--border);
        }
        
        .card::after {
            content: '┐';
            position: absolute;
            top: -1px;
            right: -1px;
            color: var(--border);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }
        
        .card-title { 
            font-size: 1.2em; 
            font-weight: 600; 
            color: var(--primary-color);
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
        }
        
        .btn {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--border);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
        }
        
        .btn::before {
            content: '[ ';
        }
        
        .btn::after {
            content: ' ]';
        }
        
        .btn:hover { 
            background: rgba(var(--primary-rgb), 0.1);
            box-shadow: var(--glow);
            text-shadow: var(--glow);
            animation: hoverGlow 1.5s ease-in-out infinite;
            transform: translateY(-1px);
            transition: all 0.2s ease;
        }
        .btn-secondary { 
            background: transparent; 
            color: var(--text-primary); 
            border: 1px solid var(--border); 
        }
        .btn-danger { 
            background: transparent; 
            color: var(--red); 
            border: 1px solid var(--red);
        }
        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.1);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5), 0 0 20px rgba(255, 0, 0, 0.3);
        }
        .btn-small { padding: 4px 10px; font-size: 12px; }
        
        .stat-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            padding: 20px;
            position: relative;
            box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.1);
        }
        
        .stat-card h3 { 
            color: var(--text-secondary); 
            font-size: 13px; 
            font-weight: 500; 
            margin-bottom: 8px; 
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .stat-value { 
            font-size: 2em; 
            font-weight: 700; 
            color: var(--primary-color);
            text-shadow: var(--glow);
        }
        .stat-sub { 
            color: var(--text-secondary); 
            font-size: 13px; 
            margin-top: 5px; 
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: var(--primary-color);
            box-shadow: var(--glow);
            background: rgba(var(--primary-rgb), 0.05);
        }
        
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        select option {
            background: var(--bg-primary) !important;
            color: var(--text-primary) !important;
        }
        
        select option:hover,
        select option:focus,
        select option:checked {
            background: rgba(var(--primary-rgb, 0, 255, 0), 0.2) !important;
            color: var(--primary-color) !important;
        }
        
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            border: 1px solid var(--border);
            table-layout: fixed;
        }
        th, td { 
            padding: 16px; 
            text-align: left; 
            border: 1px solid var(--border);
            border-top: none;
            border-left: none;
            vertical-align: middle;
        }
        
        td:nth-child(2) {
            min-height: 80px;
            padding: 20px;
        }
        th:first-child { width: 28%; }
        th:nth-child(2) { width: 32%; min-width: 220px; }
        th:nth-child(3) { width: 22%; }
        th:nth-child(4) { width: 18%; }
        th { 
            color: var(--primary-color); 
            font-weight: 600; 
            font-size: 13px; 
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
            background: rgba(var(--primary-rgb), 0.05);
        }
        td:first-child, th:first-child {
            border-left: 1px solid var(--border);
        }
        tr:hover { 
            background: rgba(var(--primary-rgb), 0.05);
            box-shadow: inset 0 0 10px rgba(var(--primary-rgb), 0.1);
        }
        
        .indicator { 
            width: 12px; 
            height: 12px; 
            display: inline-block; 
            margin-right: 8px;
            font-family: monospace;
            line-height: 1;
            vertical-align: middle;
            flex-shrink: 0;
            text-align: center;
        }
        
        table td:nth-child(2),
        table td:nth-child(3),
        table td:nth-child(4) {
            white-space: nowrap;
        }
        
        table td:first-child {
            white-space: normal;
            word-break: break-word;
        }
        .ind-normal { 
            color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color);
        }
        .ind-normal::before { content: '●'; }
        .ind-low { 
            color: var(--blue);
            text-shadow: 0 0 5px var(--blue);
        }
        .ind-low::before { content: '●'; }
        .ind-slightly-high { 
            color: var(--yellow);
            text-shadow: 0 0 5px var(--yellow);
        }
        .ind-slightly-high::before { content: '●'; }
        .ind-high { 
            color: var(--red);
            text-shadow: 0 0 5px var(--red);
        }
        .ind-high::before { content: '●'; }
        .ind-pending { 
            color: #666;
        }
        .ind-pending::before { content: '○'; }
        
        .status-normal { 
            color: var(--primary-color); 
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
        }
        .status-low { 
            color: var(--blue); 
            text-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
        }
        .status-high { 
            color: var(--red); 
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
        .status-slightly-high { 
            color: var(--yellow); 
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.5);
        }
        
        .delta { 
            font-size: 12px; 
            padding: 2px 6px; 
            border: 1px solid;
            font-weight: 600;
        }
        .delta-up { 
            border-color: var(--red);
            color: var(--red); 
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
        }
        .delta-down { 
            border-color: var(--blue);
            color: var(--blue); 
            text-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
        }
        .delta-same { 
            border-color: #666;
            color: #666; 
        }
        
        .drug-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            transition: all 0.2s;
        }
        
        .drug-card:hover {
            background: rgba(var(--primary-rgb), 0.05);
            box-shadow: 0 0 10px rgba(var(--primary-rgb), 0.2);
        }
        
        .drug-info h4 { 
            font-size: 1em; 
            margin-bottom: 4px; 
            color: var(--primary-color);
        }
        .drug-info p { 
            color: var(--text-secondary); 
            font-size: 13px; 
        }
        
        .drug-badge { 
            padding: 4px 10px; 
            border: 1px solid;
            font-size: 12px; 
            font-weight: 500;
            font-family: inherit;
        }
        .badge-oral { 
            border-color: var(--purple);
            color: var(--purple); 
            text-shadow: 0 0 5px rgba(170, 0, 255, 0.5);
        }
        .badge-inject { 
            border-color: var(--blue);
            color: var(--blue); 
            text-shadow: 0 0 5px rgba(0, 170, 255, 0.5);
        }
        
        .log-entry {
            display: flex;
            gap: 15px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            align-items: flex-start;
        }
        
        .log-date { color: var(--text-secondary); font-size: 13px; min-width: 100px; }
        .log-content { flex: 1; }
        .log-drug { font-weight: 500; }
        .log-dose { color: var(--text-secondary); font-size: 13px; }
        
        .analysis-selector { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .analysis-selector select {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 12px;
            font-size: 14px;
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2300ff00' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 30px;
        }
        
        .analysis-selector select:focus {
            outline: none;
            box-shadow: var(--glow);
            background-color: rgba(var(--primary-rgb), 0.05);
        }
        
        .analysis-selector select option {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .analysis-selector select option:hover,
        .analysis-selector select option:checked {
            background: rgba(var(--primary-rgb), 0.2);
            color: var(--primary-color);
        }
        
        .legend {
            display: flex;
            gap: 20px;
            flex-wrap: nowrap;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            align-items: center;
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        .legend-item { 
            display: flex; 
            align-items: center; 
            gap: 6px; 
            font-size: 13px; 
            color: var(--text-secondary);
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .empty-state { 
            text-align: center; 
            padding: 60px 20px; 
            color: var(--text-secondary); 
            font-family: inherit;
        }
        .empty-state h3 { 
            margin-bottom: 10px; 
            color: var(--primary-color); 
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-overlay.active { display: flex; }
        
        .modal {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(var(--primary-rgb), 0.3);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 { 
            font-size: 1.2em; 
            color: var(--primary-color);
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
        }
        .modal-close { 
            background: none; 
            border: 1px solid var(--border);
            color: var(--text-secondary); 
            font-size: 20px; 
            cursor: pointer;
            padding: 5px 10px;
            font-family: inherit;
            transition: all 0.2s;
        }
        .modal-close:hover {
            color: var(--red);
            border-color: var(--red);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }
        .modal-body { padding: 20px; }
        .modal-footer { 
            padding: 15px 20px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        }
        
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-secondary); 
            font-family: inherit;
        }
        .loading::after {
            content: '...';
            animation: blink 1s infinite;
        }
        .error { 
            color: var(--red); 
            padding: 20px; 
            text-align: center; 
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            border: 1px solid var(--red);
            font-family: inherit;
        }
        
        .tabs { 
            display: flex; 
            gap: 5px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid var(--border); 
            padding-bottom: 10px; 
        }
        .tab {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.2s;
            position: relative;
        }
        .tab::before {
            content: '> ';
            opacity: 0;
            transition: opacity 0.2s;
        }
        .tab:hover { 
            color: var(--text-primary); 
            background: rgba(var(--primary-rgb, 0, 255, 0), 0.1);
        }
        .tab.active { 
            color: var(--primary-color); 
            background: rgba(var(--primary-rgb, 0, 255, 0), 0.15);
            text-shadow: 0 0 5px var(--primary-color);
        }
        .tab.active::before {
            opacity: 1;
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .parameter-name {
            position: relative;
            cursor: help;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-decoration-color: var(--text-secondary);
            text-underline-offset: 3px;
            display: inline-block;
        }
        
        .parameter-name:hover {
            color: var(--accent);
            text-decoration-color: var(--accent);
        }
        
        table td {
            position: relative;
        }
        
        .tooltip {
            position: absolute;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px 16px;
            width: 350px;
            z-index: 1000;
            box-shadow: 0 0 20px currentColor;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-primary);
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            margin-top: 8px;
            left: 0;
            top: 100%;
            white-space: normal;
            font-family: inherit;
        }
        
        .tooltip::before {
            content: '┌';
            position: absolute;
            top: -1px;
            left: -1px;
            color: var(--border);
        }
        
        .tooltip::after {
            content: '┐';
            position: absolute;
            top: -1px;
            right: -1px;
            color: var(--border);
        }
        
        .parameter-name:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .tooltip-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-color);
            font-size: 14px;
            text-shadow: 0 0 5px rgba(var(--primary-rgb), 0.5);
        }
        
        .tooltip-description {
            color: var(--text-secondary);
            line-height: 1.6;
        }
        
        .mini-graph-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            z-index: 1000;
            pointer-events: none;
            animation: fadeIn 0.2s ease-in;
            min-width: 260px;
            max-width: 320px;
        }
        
        .mini-graph-tooltip svg {
            width: 100%;
            height: auto;
            max-width: 100%;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(5px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        #protein-graph circle {
            transition: all 0.2s;
        }
        
        #protein-graph circle:hover {
            r: 8 !important;
            filter: drop-shadow(0 0 8px var(--primary-color));
        }
        
        #protein-graph g:hover text {
            opacity: 1 !important;
        }
        
        #protein-graph svg {
            max-width: 100%;
            height: auto;
        }
        
        table td:nth-child(2) {
            position: relative;
            min-height: 100px;
        }
    </style>
    </head>
    <body>
    <div class="app">
        <header>
            <div class="header-content">
                <div class="ascii-header-block">
                    <div class="colorful-ascii">__/\\\\\\\\\\\\\\\_______/\\\\\_______/\\\_______/\\\__/\\\\\\\\\\\________/\\\\\\\\\____________/\\\\____________/\\\\_____/\\\\\\\\\___________/\\\\\\\\\__/\\\________/\\\__/\\\\\\\\\\\__/\\\\\_____/\\\__/\\\\\\\\\\\\\\\_
 _\///////\\\/////______/\\\///\\\____\///\\\___/\\\/__\/////\\\///______/\\\////////____________\/\\\\\\________/\\\\\\___/\\\\\\\\\\\\\______/\\\////////__\/\\\_______\/\\\_\/////\\\///__\/\\\\\\___\/\\\_\/\\\///////////__
  _______\/\\\_________/\\\/__\///\\\____\///\\\\\\/________\/\\\_______/\\\/_____________________\/\\\//\\\____/\\\//\\\__/\\\/////////\\\___/\\\/___________\/\\\_______\/\\\_____\/\\\_____\/\\\/\\\__\/\\\_\/\\\_____________
   _______\/\\\________/\\\______\//\\\_____\//\\\\__________\/\\\______/\\\_______________________\/\\\\///\\\/\\\/_\/\\\_\/\\\_______\/\\\__/\\\_____________\/\\\\\\\\\\\\\\\_____\/\\\_____\/\\\//\\\_\/\\\_\/\\\\\\\\\\\_____
    _______\/\\\_______\/\\\_______\/\\\______\/\\\\__________\/\\\_____\/\\\_______________________\/\\\__\///\\\/___\/\\\_\/\\\\\\\\\\\\\\\_\/\\\_____________\/\\\/////////\\\_____\/\\\_____\/\\\\//\\\\/\\\_\/\\\///////______
     _______\/\\\_______\//\\\______/\\\_______/\\\\\\_________\/\\\_____\//\\\______________________\/\\\____\///_____\/\\\_\/\\\/////////\\\_\//\\\____________\/\\\_______\/\\\_____\/\\\_____\/\\\_\//\\\/\\\_\/\\\_____________
      _______\/\\\________\///\\\__/\\\_______/\\\////\\\_______\/\\\______\///\\\____________________\/\\\_____________\/\\\_\/\\\_______\/\\\__\///\\\__________\/\\\_______\/\\\_____\/\\\_____\/\\\__\//\\\\\\_\/\\\_____________
       _______\/\\\__________\///\\\\\/______/\\\/___\///\\\__/\\\\\\\\\\\____\////\\\\\\\\\___________\/\\\_____________\/\\\_\/\\\_______\/\\\____\////\\\\\\\\\_\/\\\_______\/\\\__/\\\\\\\\\\\_\/\\\___\//\\\\\_\/\\\\\\\\\\\\\\\_
        _______\///_____________\/////_______\///_______\///__\///////////________\/////////____________\///______________\///__\///________\///________\/////////__\///________\///__\///////////__\///_____\/////__\///////////////__</div>
                    <div id="ascii-skeleton-strip"></div>
                </div>
                <nav>
                    <button class="nav-btn active" data-page="dashboard">[ ДАШБОРД ]</button>
                    <button class="nav-btn" data-page="course">[ КУРС ]</button>
                    <button class="nav-btn" data-page="analyses">[ АНАЛИЗЫ ]</button>
                    <button class="nav-btn" data-page="compare">[ СРАВНЕНИЕ ]</button>
                </nav>
            </div>
        </header>
        
        <div class="color-picker-container">
            <button class="color-picker-toggle" onclick="toggleColorPicker()">[ ЦВЕТ ]</button>
            <div class="color-picker-panel" id="color-picker-panel">
                <div class="color-presets">
                    <div class="color-preset" style="background: #00ff00;" onclick="setColor('#00ff00')" title="Зеленый"></div>
                    <div class="color-preset" style="background: #00ffff;" onclick="setColor('#00ffff')" title="Голубой"></div>
                    <div class="color-preset" style="background: #ff00ff;" onclick="setColor('#ff00ff')" title="Пурпурный"></div>
                    <div class="color-preset" style="background: #ffff00;" onclick="setColor('#ffff00')" title="Желтый"></div>
                    <div class="color-preset" style="background: #ff6600;" onclick="setColor('#ff6600')" title="Оранжевый"></div>
                    <div class="color-preset" style="background: #ff0066;" onclick="setColor('#ff0066')" title="Розовый"></div>
                    <div class="color-preset" style="background: #00ff66;" onclick="setColor('#00ff66')" title="Лайм"></div>
                    <div class="color-preset" style="background: #6600ff;" onclick="setColor('#6600ff')" title="Фиолетовый"></div>
                </div>
                <div class="color-custom">
                    <input type="color" id="custom-color" value="#00ff00" onchange="setColor(this.value)">
                    <input type="text" id="custom-color-text" value="#00ff00" placeholder="#00ff00" onchange="setColor(this.value)">
                </div>
            </div>
        </div>

        <!-- DASHBOARD PAGE -->
        <div class="page active" id="dashboard">
            <div class="stat-cards">
                <div class="stat-card">
                    <h3>Текущий курс</h3>
                    <div class="stat-value" id="course-name">—</div>
                    <div class="stat-sub" id="course-dates">Загрузка...</div>
                </div>
                <div class="stat-card">
                    <h3>День курса</h3>
                    <div class="stat-value" id="course-day">—</div>
                    <div class="stat-sub" id="course-progress">—</div>
                </div>
                <div class="stat-card">
                    <h3>Анализов</h3>
                    <div class="stat-value" id="analyses-count">0</div>
                    <div class="stat-sub" id="last-analysis">Нет данных</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ ПРЕПАРАТЫ КУРСА ]</div>
                </div>
                <div id="dashboard-drugs"><div class="loading">Загрузка...</div></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ ПОКАЗАТЕЛИ, ТРЕБУЮЩИЕ ВНИМАНИЯ ]</div>
                </div>
                <div id="dashboard-alerts"><div class="loading">Загрузка...</div></div>
            </div>
        </div>

        <!-- COURSE PAGE -->
        <div class="page" id="course">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ НАСТРОЙКИ КУРСА ]</div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Название курса</label>
                        <input type="text" id="course-title" placeholder="Например: Первый курс">
                    </div>
                    <div class="form-group">
                        <label>Дата начала</label>
                        <input type="date" id="course-start">
                    </div>
                    <div class="form-group">
                        <label>Дата окончания</label>
                        <input type="date" id="course-end">
                    </div>
                </div>
                <div class="form-group">
                    <label>Заметки</label>
                    <textarea id="course-notes" rows="3" placeholder="Цели курса, особенности..."></textarea>
                </div>
                <button class="btn" onclick="saveCourse()">[ СОХРАНИТЬ КУРС ]</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ ПРЕПАРАТЫ ]</div>
                    <button class="btn" onclick="openDrugModal()">[ + ДОБАВИТЬ ПРЕПАРАТ ]</button>
                </div>
                <div id="drugs-list"><div class="loading">Загрузка...</div></div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ ЛОГ ПРИЁМА ]</div>
                    <button class="btn" onclick="openLogModal()">[ + ДОБАВИТЬ ЗАПИСЬ ]</button>
                </div>
                <div id="intake-log"><div class="loading">Загрузка...</div></div>
            </div>
        </div>

        <!-- ANALYSES PAGE -->
        <div class="page" id="analyses">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ МОИ АНАЛИЗЫ ]</div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="openAnalysisModal()">+ Добавить вручную</button>
                        <button class="btn btn-secondary" onclick="openPdfImportModal()">[ ИМПОРТ PDF ]</button>
                    </div>
                </div>
                
                <div class="analysis-selector">
                    <label>Просмотр:</label>
                    <select id="analysis-select" onchange="displayAnalysis()">
                        <option value="">Выберите анализ...</option>
                    </select>
                    <button class="btn btn-secondary btn-small" onclick="editCurrentAnalysis()">[ РЕДАКТИРОВАТЬ ]</button>
                    <button class="btn btn-secondary btn-small" onclick="deleteCurrentAnalysis()">[ УДАЛИТЬ ]</button>
                    <button class="btn btn-secondary btn-small" onclick="copyAnalysisAsMarkdown(this)">[ КОПИРОВАТЬ КАК MD ]</button>
                </div>

                <div class="legend">
                    <div class="legend-item"><span class="indicator ind-normal"></span> В норме</div>
                    <div class="legend-item"><span class="indicator ind-low"></span> Снижен</div>
                    <div class="legend-item"><span class="indicator ind-slightly-high"></span> Чуть выше</div>
                    <div class="legend-item"><span class="indicator ind-high"></span> Повышен</div>
                </div>

                <div id="analysis-content">
                    <div class="empty-state"><h3>Выберите или добавьте анализ</h3></div>
                </div>
                
                <div id="protein-graph-container" style="margin-top: 20px; display: none; overflow-x: auto;">
                    <div class="card-title" style="margin-bottom:10px;">[ ЭЛЕКТРОФОРЕЗ БЕЛКОВЫХ ФРАКЦИЙ ]</div>
                    <div id="protein-graph" style="max-width: 100%;"></div>
                </div>
            </div>
        </div>

        <!-- COMPARE PAGE -->
        <div class="page" id="compare">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">[ СРАВНЕНИЕ АНАЛИЗОВ ]</div>
                </div>
                
                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group">
                        <label>Анализ 1 (до)</label>
                        <select id="compare-before" onchange="compareAnalyses()">
                            <option value="">Выберите...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Анализ 2 (после)</label>
                        <select id="compare-after" onchange="compareAnalyses()">
                            <option value="">Выберите...</option>
                        </select>
                    </div>
                </div>

                <div id="compare-content">
                    <div class="empty-state"><h3>Выберите два анализа для сравнения</h3></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="drug-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="drug-modal-title">[ ДОБАВИТЬ ПРЕПАРАТ ]</h2>
                <button class="modal-close" onclick="closeDrugModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Название</label>
                    <input type="text" id="drug-name" placeholder="Например: Тестостерон энантат">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Тип</label>
                        <select id="drug-type">
                            <option value="0">[ ОРАЛЬНЫЙ ]</option>
                            <option value="1">[ ИНЪЕКЦИОННЫЙ ]</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Дозировка</label>
                        <input type="text" id="drug-dosage" placeholder="250мг/мл">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Количество</label>
                        <input type="text" id="drug-amount" placeholder="10мл или 60 таб">
                    </div>
                    <div class="form-group">
                        <label>Схема приёма</label>
                        <input type="text" id="drug-schedule" placeholder="250мг E3D">
                    </div>
                </div>
                <div class="form-group">
                    <label>Заметки</label>
                    <textarea id="drug-notes" rows="3" placeholder="Дополнительная информация..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDrugModal()">Отмена</button>
                <button class="btn" onclick="saveDrug()">[ СОХРАНИТЬ ]</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="log-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="log-modal-title">[ ДОБАВИТЬ ЗАПИСЬ ]</h2>
                <button class="modal-close" onclick="closeLogModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Дата</label>
                        <input type="date" id="log-date">
                    </div>
                    <div class="form-group">
                        <label>Препарат</label>
                        <select id="log-drug"></select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Доза</label>
                        <input type="text" id="log-dose" placeholder="250мг">
                    </div>
                    <div class="form-group">
                        <label>Место / заметка</label>
                        <input type="text" id="log-note" placeholder="Дельта правая">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeLogModal()">Отмена</button>
                <button class="btn" onclick="saveLog()">[ СОХРАНИТЬ ]</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="pdf-import-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>[ ИМПОРТ АНАЛИЗА ИЗ PDF ]</h2>
                <button class="modal-close" onclick="closePdfImportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>PDF файл с анализами (KDL, Инвитро, Гемотест и др.)</label>
                    <input type="file" id="pdf-file" accept=".pdf" style="padding: 15px; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer;">
                </div>
                <div class="form-group">
                    <label>Метка анализа (опционально)</label>
                    <input type="text" id="pdf-label" placeholder="До курса / После курса / ПКТ">
                </div>
                <div id="pdf-import-status" style="display: none; margin-top: 15px; padding: 15px; border-radius: 8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePdfImportModal()">Отмена</button>
                <button class="btn" id="pdf-import-btn" onclick="importPdf()">[ ИМПОРТИРОВАТЬ ]</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="analysis-modal">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h2 id="analysis-modal-title">[ ДОБАВИТЬ АНАЛИЗ ]</h2>
                <button class="modal-close" onclick="closeAnalysisModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Дата анализа</label>
                        <input type="date" id="analysis-date">
                    </div>
                    <div class="form-group">
                        <label>Метка</label>
                        <input type="text" id="analysis-label" placeholder="До курса / После курса">
                    </div>
                    <div class="form-group">
                        <label>Лаборатория</label>
                        <input type="text" id="analysis-lab" placeholder="KDL, Инвитро...">
                    </div>
                </div>
                
                <div class="tabs">
                    <button class="tab active" data-tab="hormones">Гормоны</button>
                    <button class="tab" data-tab="lipids">Липиды</button>
                    <button class="tab" data-tab="liver">Печень</button>
                    <button class="tab" data-tab="general">Общие</button>
                </div>
                
                <div class="tab-content active" id="tab-hormones">
                    <div class="form-row">
                        <div class="form-group"><label>Тестостерон общий</label><input type="number" step="0.01" id="val-testosterone" placeholder="8.33-30.19"></div>
                        <div class="form-group"><label>Тестостерон свободный</label><input type="number" step="0.0001" id="val-free-testosterone" placeholder="0.22-0.77"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ЛГ</label><input type="number" step="0.01" id="val-lh" placeholder="0.57-12.07"></div>
                        <div class="form-group"><label>ФСГ</label><input type="number" step="0.01" id="val-fsh" placeholder="0.95-11.95"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Пролактин</label><input type="number" step="0.01" id="val-prolactin" placeholder="72.66-407.40"></div>
                        <div class="form-group"><label>Эстрадиол</label><input type="number" step="0.01" id="val-estradiol" placeholder="40-161"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ГСПГ</label><input type="number" step="0.01" id="val-shbg" placeholder="16.2-68.5"></div>
                        <div class="form-group"><label>ТТГ</label><input type="number" step="0.0001" id="val-tsh" placeholder="0.35-4.94"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-lipids">
                    <div class="form-row">
                        <div class="form-group"><label>Холестерин общий</label><input type="number" step="0.01" id="val-cholesterol" placeholder="3.4-6.3"></div>
                        <div class="form-group"><label>ЛПВП / HDL</label><input type="number" step="0.01" id="val-hdl" placeholder=">1.03"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ЛПНП / LDL</label><input type="number" step="0.01" id="val-ldl" placeholder="<2.6"></div>
                        <div class="form-group"><label>Триглицериды</label><input type="number" step="0.01" id="val-triglycerides" placeholder="<1.7"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Коэфф. атерогенности</label><input type="number" step="0.1" id="val-atherogenic" placeholder="1.0-2.5"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-liver">
                    <div class="form-row">
                        <div class="form-group"><label>АЛТ</label><input type="number" step="0.1" id="val-alt" placeholder="<50"></div>
                        <div class="form-group"><label>АСТ</label><input type="number" step="0.1" id="val-ast" placeholder="<50"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>ГГТ</label><input type="number" step="0.1" id="val-ggt" placeholder="<55"></div>
                        <div class="form-group"><label>Билирубин общий</label><input type="number" step="0.1" id="val-bilirubin" placeholder="5-21"></div>
                    </div>
                </div>
                
                <div class="tab-content" id="tab-general">
                    <div class="form-row">
                        <div class="form-group"><label>Гемоглобин</label><input type="number" step="0.1" id="val-hemoglobin" placeholder="130-170"></div>
                        <div class="form-group"><label>Гематокрит</label><input type="number" step="0.1" id="val-hematocrit" placeholder="39-49"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Глюкоза</label><input type="number" step="0.01" id="val-glucose" placeholder="3.9-6.1"></div>
                        <div class="form-group"><label>Витамин D</label><input type="number" step="0.1" id="val-vitd" placeholder="30-100"></div>
                    </div>
                </div>

                <div class="card" style="margin-top: 15px;">
                    <div class="card-header">
                        <div class="card-title">[ ДОПОЛНИТЕЛЬНЫЕ ПОКАЗАТЕЛИ ]</div>
                        <button class="btn btn-secondary btn-small" onclick="addExtraRow()">[ + ДОБАВИТЬ ]</button>
                    </div>
                    <div id="extra-rows"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAnalysisModal()">Отмена</button>
                <button class="btn" onclick="saveAnalysis()">[ СОХРАНИТЬ ]</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = ''
        
        let analyses = []
        let drugs = []
        let intakeLogs = []
        let referenceRanges = {}
        let currentCourse = null

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex)
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null
        }

        function rgbToRgba(rgb, alpha) {
            return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`
        }

        function setColor(color) {
            const rgb = hexToRgb(color)
            if (!rgb) return
            
            const root = document.documentElement
            root.style.setProperty('--primary-color', color)
            root.style.setProperty('--primary-rgb', `${rgb.r}, ${rgb.g}, ${rgb.b}`)
            root.style.setProperty('--border', color)
            root.style.setProperty('--text-primary', color)
            root.style.setProperty('--accent', color)
            root.style.setProperty('--green', color)
            
            const glowColor = rgbToRgba(rgb, 0.5)
            const glowColor2 = rgbToRgba(rgb, 0.3)
            root.style.setProperty('--glow', `0 0 10px ${glowColor}, 0 0 20px ${glowColor2}`)
            
            const textSecondary = rgbToRgba(rgb, 0.6)
            root.style.setProperty('--text-secondary', textSecondary)
            
            document.getElementById('custom-color').value = color
            document.getElementById('custom-color-text').value = color
            
            localStorage.setItem('bloodtracker-color', color)
        }

        function toggleColorPicker() {
            const panel = document.getElementById('color-picker-panel')
            panel.classList.toggle('active')
        }

        function loadSavedColor() {
            const savedColor = localStorage.getItem('bloodtracker-color')
            if (savedColor) {
                setColor(savedColor)
            }
        }

        async function api(path, options = {}) {
            const response = await fetch(`${API_URL}/api${path}`, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers }
            })
            if (!response.ok) throw new Error(`API error: ${response.status}`)
            return response.status === 204 ? null : response.json()
        }

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'))
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'))
                btn.classList.add('active')
                document.getElementById(btn.dataset.page).classList.add('active')
            })
        })

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
                tab.classList.add('active')
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active')
            })
        })

        async function loadDashboard() {
            try {
                const data = await api('/courses/dashboard')
                currentCourse = data.activeCourse
                drugs = data.drugs
                
                document.getElementById('course-name').textContent = currentCourse?.title || '—'
                document.getElementById('course-dates').textContent = currentCourse 
                    ? `${formatDate(currentCourse.startDate)} — ${formatDate(currentCourse.endDate)}`
                    : 'Не настроен'
                document.getElementById('course-day').textContent = currentCourse?.currentDay || '—'
                document.getElementById('course-progress').textContent = currentCourse 
                    ? `из ${currentCourse.totalDays} дней`
                    : '—'
                document.getElementById('analyses-count').textContent = data.analysesCount
                document.getElementById('last-analysis').textContent = data.lastAnalysisDate 
                    ? `Последний: ${formatDate(data.lastAnalysisDate)}`
                    : 'Нет данных'

                renderDashboardDrugs()
                await loadAlerts()
            } catch (e) {
                console.error('Failed to load dashboard:', e)
            }
        }

        function renderAsciiSkull() {
            const skeleton = `⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⣶⣿⣧⣤⣶⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣟⣿⣿⣿⣿⣿⣿⣛⡛⡿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢿⣹⣽⣿⣿⣿⣿⣿⣿⣿⣿⣾⣿⣿⣷⣦⣌⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⣯⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣯⡹⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠋⣴⣿⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣌⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⣾⣷⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⣿⣿⡬⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡏⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣻⣿⣿⡈⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠿⠟⣿⣉⣭⣭⣭⡿⣿⣻⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⣿⡏⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡏⣿⣿⣧⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢿⡃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⡿⢋⣤⢶⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣿⣟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⢹⣷⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠛⠛⠻⠿⠿⢿⣿⣿⣟⣹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢿⣾⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⠏⣠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⢸⣿⡏⢹⣿⣿⣿⡿⠟⠛⠛⠿⣿⣿⣿⣿⣿⠀⠐⠛⠛⠃⠀⢢⠀⢹⣿⡟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢳⣾⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⣿⡏⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣹⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⢸⡟⣿⠀⣿⡿⠋⠀⠂⠀⠀⠀⠹⣿⡖⣿⣿⠀⠀⠀⠀⠀⠀⢸⠿⠀⣿⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣾⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⡏⢠⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⢳⣻⣶⡟⠀⠀⠀⠀⠀⢸⠃⠀⣿⠧⠛⢿⣄⡀⠀⠀⣀⢀⠾⠀⢸⣿⣶⡿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢻⣿⣿⣿⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⠁⠋⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⠹⣻⡇⠀⠀⠀⠀⠀⠘⠀⣰⡏⠀⠀⠀⠻⣿⣶⣤⣉⣉⣠⣴⣿⣿⣿⢁⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣼⡿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⡇⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢿⣿⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣆⠱⢾⡄⠀⠀⠀⠀⠀⣠⣿⠀⠀⠀⠀⠀⢻⣿⣿⣿⣿⣿⣿⣿⡍⢡⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡼⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⠀⢰⠋⠉⠀⠀⠀⠀⠈⣿⣿⣿⡿⠿⢿⣿⣿⣿⡿⣡⣿⡟⣸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⢾⣿⣶⣀⣀⣶⣿⣿⣿⣦⣀⣤⢦⣤⣿⣿⣿⣿⣿⠟⢋⡿⢇⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠙⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⡿⠃⡄⠀⠀⠀⠰⠀⠀⣠⡯⣽⡛⠀⠀⡀⠈⠻⣿⡧⣾⠏⣰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡌⠿⠿⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⣿⠃⢸⠈⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣼⣟⡶⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⡇⠸⣿⣦⡀⠀⣀⣠⣾⠟⠃⢿⣧⠀⠀⠁⠘⠀⠘⣇⠀⣰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⡀⠘⢿⡿⣿⣿⣿⣿⣿⣿⠻⣿⣿⣿⡟⢃⣡⡧⠀⣾⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣮⣙⠳⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣿⡶⢈⢛⣿⣿⣿⡿⠋⢀⡆⢸⣿⡀⠀⠦⠄⠀⣸⡇⣴⣿⣿⣿⣿⣿⣿⣿⣿⣛⣿⣷⣶⣷⣶⣾⣍⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣇⠀⠈⠓⠿⡿⣿⡟⣻⢩⣯⣽⣷⠙⠃⠈⠁⢠⠴⡞⢰⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠸⣿⣿⣿⣿⠃⡼⢻⣿⣿⣟⣣⣀⡈⠁⢸⣿⣿⣿⣶⣾⢯⣿⢻⣿⣿⣿⣿⣿⣿⣿⢳⣿⣿⣿⣿⣿⣿⣿⣿⣷⡌⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡄⠀⠁⠑⡓⠛⠃⠉⣈⠉⠀⠀⠀⠀⠀⣀⣾⣾⡐⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⠆⢻⣿⣿⡟⢰⣷⠀⠪⢝⡻⢿⣿⣿⣿⣿⣿⣿⢿⣩⡷⢂⣼⣿⣿⣿⣿⣿⡟⠉⠋⠁⠈⢿⣿⠃⠀⠈⠙⢿⣿⣿⠈⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⣀⠀⠀⢳⣀⠀⡀⢀⠀⣀⣠⣖⢺⣟⣛⢸⣿⠁⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⣿⣧⠘⣿⣇⢀⠀⠁⠘⠐⠗⠾⠿⠿⠧⣼⣿⠇⣾⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⣠⣀⣀⣹⣷⡀⠀⠀⠀⠀⢻⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⠐⣍⣧⣽⣬⣧⣼⣿⣿⣿⣿⣿⡿⠟⠀⡛⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⢃⣸⣿⣿⣿⣧⠸⣿⣿⣤⣀⣆⠠⢠⠤⠤⣤⣶⣼⡟⢰⣿⣿⣿⣿⣿⣿⣿⣿⡌⡹⠋⠉⠽⠿⣿⣿⡄⠺⠣⠀⣾⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⠹⣾⣿⣿⣿⣿⣿⣿⣿⠟⠋⠀⣠⡞⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣸⣿⣿⣿⣿⣿⣆⠻⣿⣿⣿⣿⣿⣿⣿⣿⡿⠟⢉⣴⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⡁⠀⠀⠀⠀⠈⠙⠃⠀⣇⡐⠃⣼⣿⣿⣿⣿⢿⣷⣦⣍⣻⡛⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⡯⣝⣿⣿⣷⣶⣶⠛⣿⣿⣧⠸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⣿⣟⣻⣟⠛⠛⠿⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢰⣿⣿⣿⣿⣿⣿⣿⣷⠀⢩⣟⡛⠿⠿⠛⢉⣠⡔⠒⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣾⡄⢠⠀⠀⠀⠀⢸⠟⠉⠈⣿⣿⣿⣿⠇⣘⣻⣻⣿⢻⣿⣷⡿⠿⡛⢿⣟⣿⣿⣿⡿⣛⣻⣿⡇⠉⠀⠀⠉⠁⢠⣿⡏⢹⣿⣷⣾⣿⣍⢻⣿⣿⣿⣿⣿⡿⢿⣿⣿⣿⣿⣿⣷⡆⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢨⣭⣉⣿⡿⠟⠋⠐⠺⠂⣿⣤⣏⢙⣿⣿⣿⠛⠃⠀⠻⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣟⠁⠈⠀⠀⠀⢠⡾⢶⠋⡀⢹⣿⣿⣏⣿⣿⣿⣿⣿⣉⡁⠹⣿⡌⣿⣿⡿⠉⠉⠀⣀⣀⡀⠈⠁⠨⠀⠀⠀⠀⠊⠙⢃⠈⠍⠉⣿⣿⡿⠟⠛⠛⠛⢉⣉⣭⣿⣿⣿⡆⢉⠉⠁⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠻⢿⣟⠁⠀⠀⠀⠀⠒⠈⠙⠻⠿⣿⣿⣿⠏⠉⠉⠑⢶⣦⡉⢻⣿⣿⣿⣿⡿⠿⠿⣿⣿⡀⠀⠀⠃⢀⣾⡏⠉⠙⠀⠈⣿⣿⣇⣹⣿⣿⣿⣿⣏⠀⠂⢸⣿⣿⣼⠀⠀⠀⠀⠀⠠⠄⠀⠀⠀⣀⣀⣀⡀⠂⢀⣩⣴⣶⠿⠛⠉⠀⢠⣤⡄⠯⣾⣿⣿⣿⣿⣿⠇⠀⠻⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠙⣿⣶⣤⣀⡈⢀⣿⣿⣶⣶⣤⣴⣾⠀⠀⠀⠀⠀⣻⣿⣤⣿⣷⣶⣿⣿⣿⣷⣷⣦⣥⠆⣠⣾⣿⠟⠓⠀⠀⡀⠀⠈⠍⠛⢉⣿⣿⣿⣿⣿⡆⠀⣶⡻⣿⡿⠙⢻⣿⣶⣿⣶⣶⣶⣤⣾⣿⣿⣿⣿⣿⠿⠛⡉⠀⠀⠀⠊⢀⣼⣿⠻⣿⣿⣿⣿⣿⣿⣿⡀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⠀⢻⣇⠙⣽⠛⠿⢿⣾⣿⣿⣿⣿⣿⡏⢀⣤⣴⣾⣿⣿⣿⣿⣿⡛⠋⠉⠉⠉⠉⠛⣿⣿⣿⡁⢈⠉⢁⣀⠀⠀⠘⠒⢂⡀⠄⠉⢹⣿⠿⠟⠛⠁⠀⠀⢻⣷⡆⠀⣾⣿⣿⣿⣿⣿⣿⣿⣿⠹⠿⠿⠛⠉⠀⠐⠋⠡⠀⡀⠀⣠⣾⡟⢻⣷⣿⣿⣿⣿⣿⣿⣿⣷⡀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠛⣷⣤⣀⡀⣾⣿⣿⣿⣿⣿⣿⣧⠸⡿⠟⠛⠉⠁⢠⣿⣿⠃⠀⠀⠀⠀⠀⣼⣿⣿⣿⣿⠀⠈⣿⣿⡷⠉⢙⣩⠅⢠⣤⣤⣿⣿⠆⣠⠀⠀⡀⠀⠀⠹⣷⡀⠙⢿⣿⣿⣿⣿⣿⠏⢁⡀⠀⠀⠀⠀⠀⠀⢀⣐⣉⣴⣾⣿⠟⠀⠀⣿⣿⣧⣿⣿⣿⣫⠟⢻⣷⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢌⠙⠻⣿⡏⠁⣀⠀⠙⠛⠋⠁⠀⠀⠀⢀⣠⣴⣿⣿⠃⠀⠀⠀⠀⠀⢸⣿⣿⣿⣿⣃⣀⣀⠙⠟⢀⣀⡀⠀⣀⡸⢿⣿⣿⠇⣼⣷⣇⣰⠀⠀⠀⠀⠻⢷⡀⠈⢿⣿⠛⠛⠁⢠⣾⣿⣿⣿⡿⠻⡿⠿⠟⠛⣉⠙⢉⣀⣀⠀⢸⣿⡗⢸⣿⣿⡿⠃⡄⣿⣿⣇⠈⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⣦⣀⠀⠀⠀⠀⠈⣷⣿⣿⣿⣷⣦⢿⣿⣶⡿⠿⠟⠛⠋⠉⢳⣧⠀⠀⠀⡠⠖⠋⣿⡿⣿⣿⠈⢍⠻⣿⠇⠘⠀⠈⠉⠀⢠⣾⣿⡏⠀⣿⣿⡿⢿⣀⡀⠀⣀⣠⣤⣧⣤⡀⠀⠀⠀⠐⠟⠛⠉⠁⠀⠀⠀⠂⠘⠓⠚⢁⠔⠀⠀⠈⢁⣼⣿⠟⡿⣿⡏⢀⣾⣇⢸⣿⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⠿⢿⣦⣤⡀⠺⠛⠿⢿⣿⡿⠋⠀⣀⠘⠉⠀⠀⠀⠀⠀⣸⣿⠀⢀⠎⣠⣾⢰⣿⡽⣿⣿⠀⠤⠠⣤⡆⠀⠲⠶⢶⣶⣾⣿⣿⣥⣞⡁⢹⣷⣈⣿⣷⣿⣿⣿⣿⣿⣿⣿⣷⣶⡦⠀⢠⡶⠀⠀⠀⠀⠀⢀⡀⠀⠀⠀⠐⢃⣸⣶⣿⣿⣯⡿⣱⣿⡇⢼⣿⣿⢸⣿⣿⡷⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠐⠢⠀⠀⠉⠉⠛⣷⣦⣄⣸⣥⣀⣠⣦⣤⣤⣤⣤⣶⣦⣾⣿⡿⠃⢀⡌⢰⣿⡿⢸⣿⡇⣿⣿⣇⣀⣀⠈⠉⠀⣀⡀⠀⢠⣿⣿⡏⢨⢹⣷⢸⣿⣿⡌⠙⠿⠿⢿⣿⣏⣿⣿⣿⣧⠀⡆⢸⣿⣄⠀⠀⠀⠀⠈⢓⣀⣤⣴⣾⣿⣿⡿⣿⠟⠁⠀⢹⣿⣿⡌⣿⣿⢸⣿⣿⡇⡄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀`
            
            let html = '<div class="ascii-skull-container" style="text-align: center; margin: 5px 0; position: relative; overflow: visible;">'
            html += '<pre class="ascii-text glitch-enhanced" style="margin: 0; display: inline-block; position: relative; line-height: 1.0;">' + skeleton + '</pre>'
            html += '</div>'
            return html
        }
        
        const sparks = []
        const sparkChars = ['*', '·', '•', '▪', '▫', '▸', '▹']
        const MAX_SPARKS = 25
        let collisionElements = null
        let collisionCacheTime = 0
        const CACHE_DURATION = 2000
        let animationRunning = false
        
        function getCollisionElements() {
            const now = Date.now()
            if (!collisionElements || now - collisionCacheTime > CACHE_DURATION) {
                collisionElements = Array.from(document.querySelectorAll('header, nav, .container, .modal, table, button, .card'))
                collisionCacheTime = now
            }
            return collisionElements
        }
        
        function createPixelFlicker(x, y, radius = 5) {
            const chars = ['.', ':', '*', '+']
            const pixelSize = 8
            const density = 0.3
            
            for (let i = -radius; i <= radius; i++) {
                for (let j = -radius; j <= radius; j++) {
                    if (i * i + j * j <= radius * radius && Math.random() < density) {
                        const glow = document.createElement('span')
                        glow.className = 'spark-glow'
                        glow.textContent = chars[Math.floor(Math.random() * chars.length)]
                        glow.style.left = `${x + i * pixelSize}px`
                        glow.style.top = `${y + j * pixelSize}px`
                        document.body.appendChild(glow)
                        
                        setTimeout(() => {
                            if (glow.parentNode) {
                                glow.remove()
                            }
                        }, 350 + Math.random() * 250)
                    }
                }
            }
        }
        
        function createSparkGlow(x, y) {
            const chars = ['*', '+', 'x']
            const glow = document.createElement('span')
            glow.className = 'spark-glow'
            glow.textContent = chars[Math.floor(Math.random() * chars.length)]
            glow.style.left = `${x}px`
            glow.style.top = `${y}px`
            document.body.appendChild(glow)
            
            setTimeout(() => {
                if (glow.parentNode) {
                    glow.remove()
                }
            }, 450)
        }
        
        function createSparkBurst(x, y, count = 10, coneAngle = 70) {
            const baseAngle = Math.PI / 2
            const angleSpread = (coneAngle * Math.PI) / 180
            const minSpeed = 1.5
            const maxSpeed = 3.5
            
            for (let i = 0; i < count; i++) {
                const angle = baseAngle + (Math.random() - 0.5) * angleSpread
                const speed = minSpeed + Math.random() * (maxSpeed - minSpeed)
                const vx = Math.sin(angle) * speed
                const vy = Math.cos(angle) * speed
                
                createSpark(x, y, vx, vy)
            }
        }
        
        function createSpark(x, y, vx = 0, vy = 0, createGlow = false) {
            if (sparks.length >= MAX_SPARKS) {
                const oldest = sparks.shift()
                if (oldest && oldest.element.parentNode) {
                    oldest.element.remove()
                }
            }
            
            const spark = document.createElement('span')
            spark.className = 'spark'
            spark.textContent = sparkChars[Math.floor(Math.random() * sparkChars.length)]
            spark.style.left = `${x}px`
            spark.style.top = `${y}px`
            document.body.appendChild(spark)
            
            if (createGlow) {
                createSparkGlow(x, y)
            }
            
            const sparkData = {
                element: spark,
                x: x,
                y: y,
                vx: vx || (Math.random() - 0.5) * 2,
                vy: vy || Math.random() * 2 + 1,
                life: 1.0,
                bounceCount: 0,
                maxBounces: 3,
                lastCollisionCheck: 0
            }
            
            sparks.push(sparkData)
            
            if (!animationRunning) {
                animationRunning = true
                animateSparks()
            }
            
            return sparkData
        }
        
        function checkCollision(spark) {
            const elements = getCollisionElements()
            const sparkRect = {
                left: spark.x,
                top: spark.y,
                right: spark.x + 10,
                bottom: spark.y + 10
            }
            
            for (const el of elements) {
                const rect = el.getBoundingClientRect()
                if (sparkRect.left < rect.right && sparkRect.right > rect.left &&
                    sparkRect.top < rect.bottom && sparkRect.bottom > rect.top) {
                    return { element: el, rect: rect }
                }
            }
            return null
        }
        
        function animateSparks() {
            if (!animationRunning) return
            
            const now = Date.now()
            const toRemove = []
            
            for (let i = sparks.length - 1; i >= 0; i--) {
                const spark = sparks[i]
                
                if (!spark.element.parentNode) {
                    sparks.splice(i, 1)
                    continue
                }
                
                spark.vy += 0.15
                spark.x += spark.vx
                spark.y += spark.vy
                spark.life -= 0.008
                
                if (now - spark.lastCollisionCheck > 100 && spark.bounceCount < spark.maxBounces) {
                    spark.lastCollisionCheck = now
                    const collision = checkCollision(spark)
                    if (collision) {
                        const rect = collision.rect
                        const centerX = rect.left + rect.width / 2
                        const centerY = rect.top + rect.height / 2
                        const sparkCenterX = spark.x + 5
                        const sparkCenterY = spark.y + 5
                        
                        const hitX = spark.x
                        const hitY = spark.y
                        
                        createPixelFlicker(hitX, hitY, 2)
                        
                        if (spark.bounceCount === 0 && sparks.length < MAX_SPARKS - 5) {
                            setTimeout(() => {
                                createSparkBurst(hitX, hitY, 3, 60)
                            }, 50)
                        }
                        
                        if (sparkCenterX < rect.left || sparkCenterX > rect.right) {
                            spark.vx *= -0.6
                            spark.x = sparkCenterX < centerX ? rect.left - 10 : rect.right + 10
                        }
                        if (sparkCenterY < rect.top || sparkCenterY > rect.bottom) {
                            spark.vy *= -0.6
                            spark.y = sparkCenterY < centerY ? rect.top - 10 : rect.bottom + 10
                        }
                        
                        spark.bounceCount++
                        spark.vx += (Math.random() - 0.5) * 2
                        spark.vy += (Math.random() - 0.5) * 2
                    }
                }
                
                if (spark.y > window.innerHeight + 50 || spark.life <= 0 || spark.bounceCount >= spark.maxBounces) {
                    spark.element.classList.add('fading')
                    toRemove.push(i)
                } else {
                    spark.element.style.transform = `translate(${spark.x}px, ${spark.y}px)`
                    spark.element.style.opacity = spark.life
                }
            }
            
            for (let i = toRemove.length - 1; i >= 0; i--) {
                const idx = toRemove[i]
                const spark = sparks[idx]
                if (spark && spark.element.parentNode) {
                    spark.element.remove()
                }
                sparks.splice(idx, 1)
            }
            
            if (sparks.length > 0) {
                requestAnimationFrame(animateSparks)
            } else {
                animationRunning = false
            }
        }
        
        function createSparksFromElement(element) {
            if (!element || sparks.length >= MAX_SPARKS - 10) return
            
            const rect = element.getBoundingClientRect()
            const x = rect.left + Math.random() * rect.width
            const y = rect.top + Math.random() * rect.height
            
            createPixelFlicker(x, y, 5)
            
            setTimeout(() => {
                createSparkBurst(x, y, 10, 70)
            }, 250)
        }
        
        function startSparkAnimation() {
            const createSparks = () => {
                if (sparks.length >= MAX_SPARKS) return
                
                const toxicMachineElement = document.querySelector('.colorful-ascii')
                const skeletonElement = document.querySelector('.ascii-skull-container')
                
                if (toxicMachineElement) {
                    createSparksFromElement(toxicMachineElement)
                }
                if (skeletonElement) {
                    setTimeout(() => {
                        createSparksFromElement(skeletonElement)
                    }, 500)
                }
            }
            
            createSparks()
            setInterval(createSparks, 4000)
        }

        async function loadAlerts() {
            const container = document.getElementById('dashboard-alerts')
            if (analyses.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Добавьте анализы</p></div>'
                return
            }
            
            try {
                const alerts = await api(`/analyses/${analyses[0].id}/alerts`)
                if (alerts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>[ ВСЕ ПОКАЗАТЕЛИ В НОРМЕ ]</p></div>'
                } else {
                    container.innerHTML = alerts.map(a => `
                        <div class="drug-card">
                            <div class="drug-info">
                                <h4><span class="indicator ind-${getStatusClass(a.status)}"></span>${a.name}</h4>
                                <p>${a.value} ${a.unit} (норма: ${a.refMin}-${a.refMax})</p>
                            </div>
                        </div>
                    `).join('')
                }
            } catch (e) {
                console.error('Failed to load alerts:', e)
            }
        }

        function renderDashboardDrugs() {
            const container = document.getElementById('dashboard-drugs')
            if (drugs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Нет препаратов</p></div>'
                return
            }
            container.innerHTML = drugs.map(d => `
                <div class="drug-card">
                    <div class="drug-info">
                        <h4>${d.name}</h4>
                        <p>${d.dosage || ''} • ${d.schedule || ''}</p>
                    </div>
                    <span class="drug-badge ${d.type === 0 ? 'badge-oral' : 'badge-inject'}">
                        ${d.type === 0 ? '[ ОРАЛЬНЫЙ ]' : '[ ИНЪЕКЦИЯ ]'}
                    </span>
                </div>
            `).join('')
        }

        async function loadAnalyses() {
            try {
                analyses = await api('/analyses')
                updateAnalysisSelectors()
            } catch (e) {
                console.error('Failed to load analyses:', e)
            }
        }

        async function loadDrugs() {
            try {
                drugs = await api('/drugs')
                renderDrugs()
                updateLogDrugSelect()
            } catch (e) {
                console.error('Failed to load drugs:', e)
            }
        }

        async function loadIntakeLogs() {
            try {
                intakeLogs = await api('/intakelogs?count=20')
                renderIntakeLogs()
            } catch (e) {
                console.error('Failed to load logs:', e)
            }
        }

        async function loadReferenceRanges() {
            try {
                const ranges = await api('/referenceranges')
                referenceRanges = Object.fromEntries(ranges.map(r => [r.key, r]))
            } catch (e) {
                console.error('Failed to load reference ranges:', e)
            }
        }

        function renderDrugs() {
            const container = document.getElementById('drugs-list')
            if (drugs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Нет препаратов</p></div>'
                return
            }
            container.innerHTML = drugs.map(d => `
                <div class="drug-card">
                    <div class="drug-info">
                        <h4>${d.name}</h4>
                        <p>${d.dosage || ''} • ${d.amount || ''} • ${d.schedule || ''}</p>
                    </div>
                    <div style="display:flex;gap:10px;align-items:center;">
                        <span class="drug-badge ${d.type === 0 ? 'badge-oral' : 'badge-inject'}">
                            ${d.type === 0 ? '[ ОРАЛЬНЫЙ ]' : '[ ИНЪЕКЦИЯ ]'}
                        </span>
                        <button class="btn btn-secondary btn-small" onclick="editDrug('${d.id}')">[ РЕД ]</button>
                        <button class="btn btn-danger btn-small" onclick="deleteDrug('${d.id}')">[ X ]</button>
                    </div>
                </div>
            `).join('')
        }

        function renderIntakeLogs() {
            const container = document.getElementById('intake-log')
            if (intakeLogs.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Нет записей</p></div>'
                return
            }
            container.innerHTML = intakeLogs.map(l => `
                <div class="log-entry">
                    <div class="log-date">${formatDate(l.date)}</div>
                    <div class="log-content">
                        <div class="log-drug">${l.drugName}</div>
                        <div class="log-dose">${l.dose || ''} ${l.note ? '• ' + l.note : ''}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="deleteLog('${l.id}')">✕</button>
                </div>
            `).join('')
        }

        function updateAnalysisSelectors() {
            const options = analyses.map(a => `<option value="${a.id}">${formatDate(a.date)} — ${a.label}</option>`).join('')
            document.getElementById('analysis-select').innerHTML = '<option value="">Выберите анализ...</option>' + options
            document.getElementById('compare-before').innerHTML = '<option value="">Выберите...</option>' + options
            document.getElementById('compare-after').innerHTML = '<option value="">Выберите...</option>' + options
        }

        function updateLogDrugSelect() {
            document.getElementById('log-drug').innerHTML = drugs.map(d => `<option value="${d.id}">${d.name}</option>`).join('')
        }

        let editingCourseId = null
        let editingDrugId = null
        let editingLogId = null
        let editingAnalysisId = null
        let extraRows = []
        const staticAnalysisKeys = ['testosterone', 'free-testosterone', 'lh', 'fsh', 'prolactin', 'estradiol', 'shbg', 'tsh', 'cholesterol', 'hdl', 'ldl', 'triglycerides', 'atherogenic', 'alt', 'ast', 'ggt', 'bilirubin', 'hemoglobin', 'hematocrit', 'glucose', 'vitd']

        async function editCourse() {
            if (!currentCourse) {
                const course = await api('/courses/active')
                if (!course) { alert('[ НЕТ АКТИВНОГО КУРСА ]'); return }
                currentCourse = course
            }
            editingCourseId = currentCourse.id
            document.getElementById('course-title').value = currentCourse.title || ''
            document.getElementById('course-start').value = currentCourse.startDate ? formatDateForInput(currentCourse.startDate) : ''
            document.getElementById('course-end').value = currentCourse.endDate ? formatDateForInput(currentCourse.endDate) : ''
            document.getElementById('course-notes').value = currentCourse.notes || ''
        }

        function formatDateForInput(date) {
            if (typeof date === 'string') date = new Date(date)
            const d = new Date(date)
            return d.toISOString().split('T')[0]
        }

        async function saveCourse() {
            const data = {
                title: document.getElementById('course-title').value,
                startDate: document.getElementById('course-start').value || null,
                endDate: document.getElementById('course-end').value || null,
                notes: document.getElementById('course-notes').value
            }
            if (!data.title) { alert('Введите название'); return }
            
            try {
                if (editingCourseId) {
                    await api(`/courses/${editingCourseId}`, { method: 'PUT', body: JSON.stringify(data) })
                    editingCourseId = null
                } else {
                    await api('/courses', { method: 'POST', body: JSON.stringify(data) })
                }
                await loadDashboard()
                alert('[ КУРС СОХРАНЁН ]')
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        function openDrugModal(drugId = null) {
            editingDrugId = drugId
            const titleEl = document.getElementById('drug-modal-title')
            if (drugId) {
                titleEl.textContent = '[ РЕДАКТИРОВАТЬ ПРЕПАРАТ ]'
                const drug = drugs.find(d => d.id === drugId)
                if (drug) {
                    document.getElementById('drug-name').value = drug.name || ''
                    document.getElementById('drug-type').value = drug.type || 0
                    document.getElementById('drug-dosage').value = drug.dosage || ''
                    document.getElementById('drug-amount').value = drug.amount || ''
                    document.getElementById('drug-schedule').value = drug.schedule || ''
                    document.getElementById('drug-notes').value = drug.notes || ''
                }
            } else {
                titleEl.textContent = '[ ДОБАВИТЬ ПРЕПАРАТ ]'
            }
            document.getElementById('drug-modal').classList.add('active')
        }
        
        function closeDrugModal() { 
            document.getElementById('drug-modal').classList.remove('active')
            editingDrugId = null
            document.getElementById('drug-name').value = ''
            document.getElementById('drug-type').value = '0'
            document.getElementById('drug-dosage').value = ''
            document.getElementById('drug-amount').value = ''
            document.getElementById('drug-schedule').value = ''
            document.getElementById('drug-notes').value = ''
        }

        function editDrug(id) {
            openDrugModal(id)
        }

        async function saveDrug() {
            const data = {
                name: document.getElementById('drug-name').value,
                type: parseInt(document.getElementById('drug-type').value),
                dosage: document.getElementById('drug-dosage').value,
                amount: document.getElementById('drug-amount').value,
                schedule: document.getElementById('drug-schedule').value,
                notes: document.getElementById('drug-notes').value,
                courseId: currentCourse?.id || null
            }
            if (!data.name) { alert('Введите название'); return }
            
            try {
                if (editingDrugId) {
                    await api(`/drugs/${editingDrugId}`, { method: 'PUT', body: JSON.stringify(data) })
                    editingDrugId = null
                } else {
                    await api('/drugs', { method: 'POST', body: JSON.stringify(data) })
                }
                closeDrugModal()
                await loadDrugs()
                await loadDashboard()
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        async function deleteDrug(id) {
            if (!confirm('[ УДАЛИТЬ ПРЕПАРАТ? ]')) return
            try {
                await api(`/drugs/${id}`, { method: 'DELETE' })
                await loadDrugs()
                await loadDashboard()
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        function openLogModal(logId = null) {
            if (drugs.length === 0) { alert('Сначала добавьте препараты'); return }
            editingLogId = logId
            const titleEl = document.getElementById('log-modal-title')
            if (logId) {
                titleEl.textContent = '[ РЕДАКТИРОВАТЬ ЗАПИСЬ ]'
                const log = intakeLogs.find(l => l.id === logId)
                if (log) {
                    document.getElementById('log-date').value = formatDateForInput(log.date)
                    document.getElementById('log-drug').value = log.drugId
                    document.getElementById('log-dose').value = log.dose || ''
                    document.getElementById('log-note').value = log.note || ''
                }
            } else {
                titleEl.textContent = '[ ДОБАВИТЬ ЗАПИСЬ ]'
                document.getElementById('log-date').value = new Date().toISOString().split('T')[0]
                document.getElementById('log-drug').value = ''
                document.getElementById('log-dose').value = ''
                document.getElementById('log-note').value = ''
            }
            document.getElementById('log-modal').classList.add('active')
        }
        
        function closeLogModal() { 
            document.getElementById('log-modal').classList.remove('active')
            editingLogId = null
        }

        function editLog(id) {
            openLogModal(id)
        }

        async function saveLog() {
            const data = {
                date: document.getElementById('log-date').value,
                drugId: document.getElementById('log-drug').value,
                dose: document.getElementById('log-dose').value,
                note: document.getElementById('log-note').value
            }
            
            try {
                if (editingLogId) {
                    await api(`/intakelogs/${editingLogId}`, { method: 'PUT', body: JSON.stringify(data) })
                    editingLogId = null
                } else {
                    await api('/intakelogs', { method: 'POST', body: JSON.stringify(data) })
                }
                closeLogModal()
                await loadIntakeLogs()
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        async function deleteLog(id) {
            try {
                await api(`/intakelogs/${id}`, { method: 'DELETE' })
                await loadIntakeLogs()
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        function renderExtraRows() {
            const container = document.getElementById('extra-rows')
            if (extraRows.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Нет дополнительных показателей</p></div>'
                return
            }
            const options = Object.values(referenceRanges)
                .map(r => `<option value="${r.key}">${r.name} (${r.unit})</option>`)
                .join('')
            container.innerHTML = extraRows.map(row => `
                <div class="form-row" data-row="${row.id}" style="align-items:center; gap:10px; margin-bottom:8px;">
                    <div class="form-group" style="flex:2; min-width:220px;">
                        <label>Показатель</label>
                        <select onchange="changeExtraKey('${row.id}', this.value)">
                            <option value="">Выберите...</option>
                            ${options}
                        </select>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Значение</label>
                        <input type="number" step="0.0001" value="${row.value ?? ''}" onchange="changeExtraValue('${row.id}', this.value)">
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeExtraRow('${row.id}')" style="margin-top:22px;">[ X ]</button>
                </div>
            `).join('')
            extraRows.forEach(row => {
                const rowEl = container.querySelector(`[data-row="${row.id}"] select`)
                if (rowEl) rowEl.value = row.key || ''
            })
        }

        function addExtraRow() {
            const id = crypto.randomUUID()
            extraRows.push({ id, key: '', value: null })
            renderExtraRows()
        }

        function removeExtraRow(id) {
            extraRows = extraRows.filter(r => r.id !== id)
            renderExtraRows()
        }

        function changeExtraKey(id, key) {
            const row = extraRows.find(r => r.id === id)
            if (!row) return
            row.key = key
        }

        function changeExtraValue(id, value) {
            const row = extraRows.find(r => r.id === id)
            if (!row) return
            row.value = value === '' ? null : parseFloat(value)
        }

        function openAnalysisModal(analysisId = null) {
            editingAnalysisId = analysisId
            const titleEl = document.getElementById('analysis-modal-title')
            const dateEl = document.getElementById('analysis-date')
            const labelEl = document.getElementById('analysis-label')
            const labEl = document.getElementById('analysis-lab')
            const keys = ['testosterone', 'free-testosterone', 'lh', 'fsh', 'prolactin', 'estradiol', 'shbg', 'tsh',
                         'cholesterol', 'hdl', 'ldl', 'triglycerides', 'atherogenic',
                         'alt', 'ast', 'ggt', 'bilirubin', 'hemoglobin', 'hematocrit', 'glucose', 'vitd']

            if (analysisId) {
                titleEl.textContent = '[ РЕДАКТИРОВАТЬ АНАЛИЗ ]'
                const analysis = analyses.find(a => a.id === analysisId)
                if (analysis) {
                    dateEl.value = formatDateForInput(analysis.date)
                    labelEl.value = analysis.label || ''
                    labEl.value = analysis.laboratory || ''
                    keys.forEach(key => {
                        const input = document.getElementById('val-' + key)
                        if (!input) return
                        const value = analysis.values && Object.prototype.hasOwnProperty.call(analysis.values, key)
                            ? analysis.values[key]
                            : null
                        input.value = value != null ? value : ''
                    })
                    extraRows = Object.entries(analysis.values || {})
                        .filter(([k]) => !staticAnalysisKeys.includes(k))
                        .map(([k, v]) => ({ id: crypto.randomUUID(), key: k, value: v }))
                }
            } else {
                titleEl.textContent = '[ ДОБАВИТЬ АНАЛИЗ ]'
                dateEl.value = new Date().toISOString().split('T')[0]
                labelEl.value = ''
                labEl.value = ''
                keys.forEach(key => {
                    const input = document.getElementById('val-' + key)
                    if (input) input.value = ''
                })
                extraRows = []
            }

            document.getElementById('analysis-modal').classList.add('active')
            renderExtraRows()
        }
        function closeAnalysisModal() { 
            document.getElementById('analysis-modal').classList.remove('active')
            editingAnalysisId = null
        }

        function openPdfImportModal() {
            document.getElementById('pdf-file').value = ''
            document.getElementById('pdf-label').value = ''
            document.getElementById('pdf-import-status').style.display = 'none'
            document.getElementById('pdf-import-btn').disabled = false
            document.getElementById('pdf-import-modal').classList.add('active')
        }
        function closePdfImportModal() { document.getElementById('pdf-import-modal').classList.remove('active') }

        async function importPdf() {
            const fileInput = document.getElementById('pdf-file')
            const label = document.getElementById('pdf-label').value
            const statusDiv = document.getElementById('pdf-import-status')
            const importBtn = document.getElementById('pdf-import-btn')

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Выберите PDF файл')
                return
            }

            const file = fileInput.files[0]
            if (!file.name.toLowerCase().endsWith('.pdf')) {
                alert('Требуется PDF файл')
                return
            }

            importBtn.disabled = true
            importBtn.textContent = '⏳ Обработка...'
            statusDiv.style.display = 'block'
            statusDiv.style.background = 'var(--bg-tertiary)'
            statusDiv.innerHTML = '<div style="color: var(--text-secondary)">Анализируем PDF файл...</div>'

            const formData = new FormData()
            formData.append('file', file)
            if (label) formData.append('label', label)

            try {
                const response = await fetch(`${API_URL}/api/analyses/import-pdf`, {
                    method: 'POST',
                    body: formData
                })

                const result = await response.json()

                if (result.success) {
                    statusDiv.style.background = 'rgba(63, 185, 80, 0.1)'
                    statusDiv.innerHTML = `
                        <div style="color: var(--primary-color); font-weight: 600; margin-bottom: 10px;">[ ИМПОРТ УСПЕШЕН ]</div>
                        <div style="color: var(--text-secondary); font-size: 13px;">
                            <p>[ ДАТА ]: ${formatDate(result.detectedDate)}</p>
                            <p>[ ЛАБОРАТОРИЯ ]: ${result.detectedLaboratory || 'Не определена'}</p>
                            <p>[ РАСПОЗНАНО ПОКАЗАТЕЛЕЙ ]: <strong>${result.parsedValuesCount}</strong></p>
                            ${result.unrecognizedItems?.length > 0 ? `<p style="margin-top: 10px; color: var(--yellow);">[ ! ] НЕ РАСПОЗНАНО СТРОК: ${result.unrecognizedItems.length}</p>` : ''}
                        </div>
                    `
                    
                    setTimeout(async () => {
                        closePdfImportModal()
                        await loadAnalyses()
                        await loadDashboard()
                        
                        if (result.analysis) {
                            document.getElementById('analysis-select').value = result.analysis.id
                            displayAnalysis()
                        }
                    }, 2000)
                } else {
                    statusDiv.style.background = 'rgba(248, 81, 73, 0.1)'
                    statusDiv.innerHTML = `
                        <div style="color: var(--red); font-weight: 600; margin-bottom: 10px;">[ ОШИБКА ИМПОРТА ]</div>
                        <div style="color: var(--text-secondary); font-size: 13px;">
                            <p>${result.errorMessage || 'Неизвестная ошибка'}</p>
                            ${result.unrecognizedItems?.length > 0 ? `
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: var(--accent);">Нераспознанные строки (${result.unrecognizedItems.length})</summary>
                                    <ul style="margin-top: 5px; padding-left: 20px; font-size: 12px;">
                                        ${result.unrecognizedItems.slice(0, 10).map(i => `<li>${i}</li>`).join('')}
                                        ${result.unrecognizedItems.length > 10 ? `<li>...и ещё ${result.unrecognizedItems.length - 10}</li>` : ''}
                                    </ul>
                                </details>
                            ` : ''}
                        </div>
                    `
                    importBtn.disabled = false
                    importBtn.textContent = '[ ИМПОРТИРОВАТЬ ]'
                }
            } catch (e) {
                statusDiv.style.background = 'rgba(248, 81, 73, 0.1)'
                statusDiv.innerHTML = `<div style="color: var(--red);">[ ОШИБКА ]: ${e.message}</div>`
                importBtn.disabled = false
                importBtn.textContent = '📥 Импортировать'
            }
        }

        function editCurrentAnalysis() {
            const id = document.getElementById('analysis-select').value
            if (!id) return
            openAnalysisModal(id)
        }

        async function saveAnalysis() {
            const values = {}
            const keys = ['testosterone', 'free-testosterone', 'lh', 'fsh', 'prolactin', 'estradiol', 'shbg', 'tsh',
                         'cholesterol', 'hdl', 'ldl', 'triglycerides', 'atherogenic',
                         'alt', 'ast', 'ggt', 'bilirubin', 'hemoglobin', 'hematocrit', 'glucose', 'vitd']
            
            keys.forEach(key => {
                const input = document.getElementById('val-' + key)
                if (input && input.value) values[key] = parseFloat(input.value)
            })

            extraRows.forEach(r => {
                if (!r.key || r.value == null || Number.isNaN(r.value)) return
                values[r.key] = r.value
            })

            const data = {
                date: document.getElementById('analysis-date').value,
                label: document.getElementById('analysis-label').value,
                laboratory: document.getElementById('analysis-lab').value,
                values: values
            }
            
            if (!data.date || !data.label) { alert('Заполните дату и метку'); return }
            
            try {
                if (editingAnalysisId) {
                    const id = editingAnalysisId
                    data.id = id
                    await api(`/analyses/${id}`, { method: 'PUT', body: JSON.stringify(data) })
                    editingAnalysisId = null
                    closeAnalysisModal()
                    await loadAnalyses()
                    await loadDashboard()
                    document.getElementById('analysis-select').value = id
                    displayAnalysis()
                    alert('[ АНАЛИЗ ОБНОВЛЁН ]')
                } else {
                    await api('/analyses', { method: 'POST', body: JSON.stringify(data) })
                    closeAnalysisModal()
                    await loadAnalyses()
                    await loadDashboard()
                    alert('[ АНАЛИЗ СОХРАНЁН ]')
                }
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        async function displayAnalysis() {
            const id = document.getElementById('analysis-select').value
            if (!id) return
            
            const analysis = analyses.find(a => a.id === id)
            if (!analysis) return
            
            const container = document.getElementById('analysis-content')
            const items = Object.entries(analysis.values)
                .map(([key, value]) => {
                    const ref = referenceRanges[key]
                    if (!ref) return null
                    return { key, value, ref, status: getStatus(value, ref) }
                })
                .filter(Boolean)

            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state">' + renderAsciiSkull() + '<h3>Нет данных</h3></div>'
                return
            }

            const order = ['Гормоны', 'Липиды', 'Печень', 'Коагуляция', 'Общие']
            const groups = {}
            items.forEach(i => {
                const cat = i.ref.category || 'Прочие'
                if (!groups[cat]) groups[cat] = []
                groups[cat].push(i)
            })

            const sortedCategories = Object.keys(groups).sort((a, b) => {
                const ia = order.indexOf(a)
                const ib = order.indexOf(b)
                const oa = ia === -1 ? 99 : ia
                const ob = ib === -1 ? 99 : ib
                if (oa !== ob) return oa - ob
                return a.localeCompare(b)
            })

            let html = `<table><thead><tr><th>Показатель</th><th>Результат</th><th>Референс</th><th>Статус</th></tr></thead><tbody>`

            sortedCategories.forEach(cat => {
                html += `<tr><td colspan="4" style="background:var(--bg-tertiary); font-weight:600;">${cat}</td></tr>`
                groups[cat]
                    .sort((a, b) => a.ref.name.localeCompare(b.ref.name))
                    .forEach(({ key, value, ref, status }) => {
                        const description = ref.description || ''
                        const refText = ref.max === 999 ? `>${ref.min}` : (ref.min === 0 && ref.max < 10 ? `<${ref.max}` : `${ref.min} - ${ref.max}`)
                        html += `<tr data-param-key="${key}">
                            <td>
                                <span class="parameter-name">
                                    ${ref.name}
                                    ${description ? `<div class="tooltip">
                                        <div class="tooltip-title">${ref.name}</div>
                                        <div class="tooltip-description">${description}</div>
                                    </div>` : ''}
                                </span>
                            </td>
                            <td><span class="indicator ind-${getStatusClass(status)}"></span><strong>${value}</strong> ${ref.unit}</td>
                            <td style="color:var(--text-secondary)">${refText} ${ref.unit}</td>
                            <td class="status-${getStatusClass(status)}">${getStatusText(status)}</td>
                        </tr>`
                    })
            })

            html += '</tbody></table>'
            container.innerHTML = html
            renderProteinGraph(analysis)
            
            setTimeout(() => {
                container.querySelectorAll('tr[data-param-key]').forEach(row => {
                    const key = row.getAttribute('data-param-key')
                    if (!key) return
                    const ref = referenceRanges[key]
                    if (!ref) return
                    const value = analysis.values[key]
                    if (value == null || Number.isNaN(value)) return
                    const td = row.querySelector('td:nth-child(2)')
                    if (!td) return
                    
                    const refMin = ref.min
                    const refMax = ref.max === 999 ? value * 1.5 : ref.max
                    
                    td.style.position = 'relative'
                    td.style.cursor = 'pointer'
                    const miniGraph = document.createElement('div')
                    miniGraph.className = 'mini-graph-tooltip'
                    miniGraph.style.display = 'none'
                    td.appendChild(miniGraph)
                    
                    td.addEventListener('mouseenter', () => {
                        const rect = td.getBoundingClientRect()
                        const graphWidth = 260
                        const graphHeight = 140
                        const paddingTop = 25
                        const paddingBottom = 25
                        const paddingLeft = 18
                        const paddingRight = 18
                        const innerW = graphWidth - paddingLeft - paddingRight
                        const innerH = graphHeight - paddingTop - paddingBottom
                        
                        let minVal = refMin
                        let maxVal = refMax === 999 ? value * 1.5 : refMax
                        
                        if (value < refMin) {
                            const margin = (refMax - refMin) * 0.2
                            minVal = Math.max(0, value - margin)
                        }
                        if (value > refMax) {
                            const margin = (refMax - refMin) * 0.2
                            maxVal = value + margin
                        }
                        
                        const valRange = maxVal - minVal
                        
                        const x1 = paddingLeft
                        const x2 = paddingLeft + innerW / 2
                        const x3 = paddingLeft + innerW
                        
                        const baseY = graphHeight - paddingBottom
                        const y1 = baseY - ((refMin - minVal) / valRange) * innerH
                        const y2 = baseY - ((value - minVal) / valRange) * innerH
                        const y3 = baseY - ((refMax - minVal) / valRange) * innerH
                        
                        const status = getStatus(value, ref)
                        const statusColor = status === 0 ? 'var(--green)' : status === 1 ? 'var(--blue)' : status === 2 ? 'var(--yellow)' : 'var(--red)'
                        const mainColor = status === 0 ? 'var(--primary-color)' : statusColor
                        
                        const graphPath = `M ${x1} ${y1} L ${x2} ${y2} L ${x3} ${y3}`
                        const pathLength = Math.sqrt((x2-x1)*(x2-x1) + (y2-y1)*(y2-y1)) + Math.sqrt((x3-x2)*(x3-x2) + (y3-y2)*(y3-y2))
                        const glowLength = pathLength * 0.25
                        
                        // Позиция подписи значения: всегда с явным отступом от точки,
                        // чтобы текст не перекрывал сам маркер
                        let valTextY
                        const offsetUp = 20
                        const offsetDown = 26
                        // По умолчанию: если точка в верхней половине графика — подпись ниже, иначе выше
                        if (y2 < paddingTop + innerH / 2) {
                            valTextY = y2 + offsetDown
                        } else {
                            valTextY = y2 - offsetUp
                        }
                        // Коррекция, если выходим за границы
                        if (valTextY < paddingTop + 10) {
                            valTextY = paddingTop + 10
                        } else if (valTextY > graphHeight - paddingBottom - 8) {
                            valTextY = graphHeight - paddingBottom - 8
                        }
                        
                        const gradientId = 'mini-grad-' + Date.now()
                        miniGraph.innerHTML = `
                            <svg width="${graphWidth}" height="${graphHeight}" viewBox="0 0 ${graphWidth} ${graphHeight}" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="100%" y2="0%">
                                        <stop offset="0%" stop-color="${mainColor}" stop-opacity="0" />
                                        <stop offset="25%" stop-color="${mainColor}" stop-opacity="0.1" />
                                        <stop offset="40%" stop-color="${mainColor}" stop-opacity="0.5" />
                                        <stop offset="50%" stop-color="${mainColor}" stop-opacity="1" />
                                        <stop offset="60%" stop-color="${mainColor}" stop-opacity="0.5" />
                                        <stop offset="75%" stop-color="${mainColor}" stop-opacity="0.1" />
                                        <stop offset="100%" stop-color="${mainColor}" stop-opacity="0" />
                                    </linearGradient>
                                    <filter id="mini-glow-${gradientId}">
                                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                        <feMerge>
                                            <feMergeNode in="coloredBlur"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>
                                    ${status >= 2 ? `<filter id="glitch-${gradientId}" x="-50%" y="-50%" width="200%" height="200%">
                                        <feOffset in="SourceGraphic" dx="0" dy="0" result="offset1">
                                            <animate attributeName="dx" values="0;-2;2;-2;0" dur="0.1s" repeatCount="indefinite"/>
                                        </feOffset>
                                        <feOffset in="SourceGraphic" dx="0" dy="0" result="offset2">
                                            <animate attributeName="dx" values="0;2;-2;2;0" dur="0.15s" repeatCount="indefinite"/>
                                        </feOffset>
                                        <feComponentTransfer in="offset1" result="red">
                                            <feFuncR type="discrete" tableValues="1 0 1 0"/>
                                        </feComponentTransfer>
                                        <feComponentTransfer in="offset2" result="cyan">
                                            <feFuncG type="discrete" tableValues="0 1 0 1"/>
                                            <feFuncB type="discrete" tableValues="1 0 1 0"/>
                                        </feComponentTransfer>
                                        <feMerge>
                                            <feMergeNode in="red"/>
                                            <feMergeNode in="cyan"/>
                                            <feMergeNode in="SourceGraphic"/>
                                        </feMerge>
                                    </filter>` : ''}
                                </defs>
                                <rect x="0" y="0" width="${graphWidth}" height="${graphHeight}" fill="var(--bg-secondary)" stroke="var(--border)" stroke-width="1" rx="4"/>
                                <line x1="${paddingLeft}" y1="${baseY}" x2="${paddingLeft + innerW}" y2="${baseY}" stroke="var(--border)" stroke-width="1" opacity="0.5"/>
                                <path d="${graphPath}" fill="none" stroke="${mainColor}" stroke-width="2" opacity="0.25"/>
                                <path d="${graphPath}" fill="none" stroke="url(#${gradientId})" stroke-width="3" filter="${status >= 2 ? `url(#glitch-${gradientId})` : `url(#mini-glow-${gradientId})`}" stroke-dasharray="${glowLength} ${pathLength}" stroke-dashoffset="0">
                                    <animate attributeName="stroke-dashoffset" values="0;${pathLength + glowLength}" dur="3s" repeatCount="indefinite"/>
                                    ${status >= 2 ? `<animate attributeName="stroke-width" values="3;4;3;5;3" dur="0.2s" repeatCount="indefinite"/>` : ''}
                                </path>
                                <circle cx="${x1}" cy="${y1}" r="5" fill="var(--text-secondary)" opacity="0.8"/>
                                <circle cx="${x2}" cy="${y2}" r="7" fill="${statusColor}" filter="url(#mini-glow-${gradientId})">
                                    <animate attributeName="r" values="7;9;7" dur="1.5s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="${x3}" cy="${y3}" r="5" fill="var(--text-secondary)" opacity="0.8"/>
                                <text x="${x1}" y="${Math.max(y1 - 12, paddingTop + 5)}" text-anchor="middle" font-size="10" fill="var(--text-secondary)" font-weight="500">${refMin.toFixed(1)}</text>
                                <text x="${x2}" y="${valTextY}" text-anchor="middle" font-size="11" fill="${statusColor}" font-weight="bold">${value.toFixed(ref.unit === '%' ? 1 : 2)}</text>
                                <text x="${x3}" y="${Math.max(y3 - 12, paddingTop + 5)}" text-anchor="middle" font-size="10" fill="var(--text-secondary)" font-weight="500">${refMax === 999 ? '>' + refMin.toFixed(1) : refMax.toFixed(1)}</text>
                                <text x="${paddingLeft}" y="${paddingTop - 5}" font-size="10" fill="var(--text-secondary)" font-weight="500">${ref.name}</text>
                            </svg>
                        `
                        miniGraph.style.display = 'block'
                    })
                    
                    td.addEventListener('mouseleave', () => {
                        miniGraph.style.display = 'none'
                    })
                })
            }, 100)
        }

        async function deleteCurrentAnalysis() {
            const id = document.getElementById('analysis-select').value
            if (!id) return
            if (!confirm('[ УДАЛИТЬ АНАЛИЗ? ]')) return
            
            try {
                await api(`/analyses/${id}`, { method: 'DELETE' })
                await loadAnalyses()
                await loadDashboard()
                document.getElementById('analysis-content').innerHTML = '<div class="empty-state"><h3>Выберите анализ</h3></div>'
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        async function compareAnalyses() {
            const beforeId = document.getElementById('compare-before').value
            const afterId = document.getElementById('compare-after').value
            if (!beforeId || !afterId) return
            
            try {
                const data = await api(`/analyses/compare?beforeId=${beforeId}&afterId=${afterId}`)
                
                let html = `<table><thead><tr>
                    <th>Показатель</th>
                    <th>${data.before.label}</th>
                    <th>${data.after.label}</th>
                    <th>Изменение</th>
                </tr></thead><tbody>`
                
                for (const c of data.comparisons) {
                    let deltaHtml = '—'
                    if (c.deltaPercent !== null) {
                        const cls = c.deltaPercent > 0 ? 'delta-up' : c.deltaPercent < 0 ? 'delta-down' : 'delta-same'
                        const sign = c.deltaPercent > 0 ? '↑ +' : c.deltaPercent < 0 ? '↓ ' : '= '
                        deltaHtml = `<span class="delta ${cls}">${sign}${c.deltaPercent.toFixed(1)}%</span>`
                    }
                    
                    const ref = referenceRanges[c.key]
                    const description = ref?.description || ''
                    
                    html += `<tr>
                        <td>
                            ${description ? `<span class="parameter-name">
                                ${c.name}
                                <div class="tooltip">
                                    <div class="tooltip-title">${c.name}</div>
                                    <div class="tooltip-description">${description}</div>
                                </div>
                            </span>` : c.name}
                        </td>
                        <td><span class="indicator ind-${getStatusClass(c.beforeStatus)}"></span>${c.beforeValue ?? '—'}</td>
                        <td><span class="indicator ind-${getStatusClass(c.afterStatus)}"></span>${c.afterValue ?? '—'}</td>
                        <td>${deltaHtml}</td>
                    </tr>`
                }
                
                html += '</tbody></table>'
                document.getElementById('compare-content').innerHTML = html
            } catch (e) {
                alert('Ошибка: ' + e.message)
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '—'
            return new Date(dateStr).toLocaleDateString('ru-RU')
        }

        function getStatus(value, ref) {
            const margin = (ref.max - ref.min) * 0.1
            if (value < ref.min) return 1
            if (value > ref.max + margin) return 3
            if (value > ref.max) return 2
            return 0
        }

        function getStatusClass(status) {
            return ['normal', 'low', 'slightly-high', 'high', 'pending'][status] || 'pending'
        }

        function getStatusText(status) {
            return ['✓ Норма', '↓ Снижен', '↑ Чуть выше', '↑↑ Повышен', '—'][status] || '—'
        }

        function copyAnalysisAsMarkdown(button) {
            const id = document.getElementById('analysis-select').value
            if (!id) {
                alert('Выберите анализ для копирования')
                return
            }
            
            const analysis = analyses.find(a => a.id === id)
            if (!analysis) {
                alert('Анализ не найден')
                return
            }
            
            const items = Object.entries(analysis.values)
                .map(([key, value]) => {
                    const ref = referenceRanges[key]
                    if (!ref) return null
                    return { key, value, ref, status: getStatus(value, ref) }
                })
                .filter(Boolean)

            if (items.length === 0) {
                alert('Нет данных для копирования')
                return
            }

            const order = ['Гормоны', 'Липиды', 'Печень', 'Коагуляция', 'Общие']
            const groups = {}
            items.forEach(i => {
                const cat = i.ref.category || 'Прочие'
                if (!groups[cat]) groups[cat] = []
                groups[cat].push(i)
            })

            const sortedCategories = Object.keys(groups).sort((a, b) => {
                const ia = order.indexOf(a)
                const ib = order.indexOf(b)
                const oa = ia === -1 ? 99 : ia
                const ob = ib === -1 ? 99 : ib
                if (oa !== ob) return oa - ob
                return a.localeCompare(b)
            })

            let markdown = `# Анализ крови\n\n`
            markdown += `**Дата:** ${formatDate(analysis.date)}\n`
            if (analysis.label) {
                markdown += `**Метка:** ${analysis.label}\n`
            }
            markdown += `\n`

            sortedCategories.forEach(cat => {
                markdown += `## ${cat}\n\n`
                markdown += `| Показатель | Результат | Референс | Статус |\n`
                markdown += `|------------|-----------|----------|--------|\n`
                
                groups[cat]
                    .sort((a, b) => a.ref.name.localeCompare(b.ref.name))
                    .forEach(({ key, value, ref, status }) => {
                        const refText = ref.max === 999 ? `>${ref.min}` : (ref.min === 0 && ref.max < 10 ? `<${ref.max}` : `${ref.min} - ${ref.max}`)
                        const statusText = getStatusText(status)
                        markdown += `| ${ref.name} | **${value}** ${ref.unit} | ${refText} ${ref.unit} | ${statusText} |\n`
                    })
                
                markdown += `\n`
            })

            navigator.clipboard.writeText(markdown).then(() => {
                const originalText = button.textContent
                button.textContent = '[ СКОПИРОВАНО! ]'
                button.style.color = '#00ff00'
                setTimeout(() => {
                    button.textContent = originalText
                    button.style.color = ''
                }, 2000)
            }).catch(err => {
                console.error('Ошибка копирования:', err)
                alert('Ошибка при копировании в буфер обмена')
            })
        }

        function renderProteinGraph(analysis) {
            const container = document.getElementById('protein-graph-container')
            const graph = document.getElementById('protein-graph')
            if (!container || !graph) return

            const defs = [
                { key: 'albumin-percent', label: 'Albumin' },
                { key: 'alpha1-globulin-percent', label: 'Alpha 1' },
                { key: 'alpha2-globulin-percent', label: 'Alpha 2' },
                { key: 'beta1-globulin-percent', label: 'Beta 1' },
                { key: 'beta2-globulin-percent', label: 'Beta 2' },
                { key: 'gamma-globulin-percent', label: 'Gamma' }
            ]

            const points = []
            let maxVal = 0

            defs.forEach(d => {
                const v = analysis.values && Object.prototype.hasOwnProperty.call(analysis.values, d.key)
                    ? analysis.values[d.key]
                    : null
                if (v != null && !Number.isNaN(v) && v > 0) {
                    points.push({ label: d.label, value: v })
                    if (v > maxVal) maxVal = v
                }
            })

            if (points.length < 2 || maxVal <= 0) {
                container.style.display = 'none'
                graph.innerHTML = ''
                return
            }

            const containerWidth = container.clientWidth || 700
            const width = Math.min(containerWidth - 40, 700)
            const height = 350
            const paddingLeft = 60
            const paddingRight = 20
            const paddingTop = 70
            const paddingBottom = 50
            const innerWidth = width - paddingLeft - paddingRight
            const innerHeight = height - paddingTop - paddingBottom
            const stepX = points.length > 1 ? innerWidth / (points.length - 1) : innerWidth

            const baseY = paddingTop + innerHeight
            let pathD = 'M ' + paddingLeft + ' ' + baseY
            const circleParts = []
            const labelParts = []
            const curvePoints = [{ x: paddingLeft, y: baseY }]

            points.forEach((p, i) => {
                const centerX = paddingLeft + stepX * i
                const heightFactor = p.label === 'Albumin' ? 1.6 : 1.0
                const normalized = Math.min((p.value / maxVal) * heightFactor, 1.0)
                const peakY = baseY - normalized * innerHeight
                const widthFactor = p.label === 'Albumin' ? 0.18 : 0.45
                const leftX = i === 0 ? centerX : centerX - stepX * widthFactor
                const rightX = i === points.length - 1 ? centerX : centerX + stepX * widthFactor

                if (leftX > curvePoints[curvePoints.length - 1].x) {
                    pathD += ' L ' + leftX + ' ' + baseY
                    curvePoints.push({ x: leftX, y: baseY })
                }

                pathD += ' L ' + centerX + ' ' + peakY + ' L ' + rightX + ' ' + baseY
                curvePoints.push({ x: centerX, y: peakY })
                curvePoints.push({ x: rightX, y: baseY })

                const circleId = 'protein-circle-' + i
                const peakHeight = baseY - peakY
                const textOffset = Math.max(60, peakHeight * 0.3 + 40)
                let tooltipY = peakY - textOffset
                if (tooltipY < paddingTop + 20) {
                    tooltipY = paddingTop + 20
                }
                circleParts.push(
                    '<g id="' + circleId + '">' +
                    '<circle cx="' + centerX + '" cy="' + peakY + '" r="' + (p.label === 'Albumin' ? 5 : 4) + '" fill="var(--primary-color)" style="cursor:pointer;">' +
                    '<animate attributeName="r" values="' + (p.label === 'Albumin' ? 5 : 4) + ';' + (p.label === 'Albumin' ? 7 : 6) + ';' + (p.label === 'Albumin' ? 5 : 4) + '" dur="2s" repeatCount="indefinite" />' +
                    '</circle>' +
                    '<text x="' + centerX + '" y="' + tooltipY + '" text-anchor="middle" font-size="11" fill="var(--primary-color)" opacity="0" pointer-events="none" id="tooltip-' + circleId + '">' + p.value.toFixed(1) + ' %</text>' +
                    '</g>'
                )
                labelParts.push('<text x="' + centerX + '" y="' + (height - paddingBottom + 18) + '" text-anchor="middle" font-size="12" fill="var(--text-secondary)">' + p.label + '</text>')
            })

            let pathLength = 0
            for (let i = 0; i < curvePoints.length - 1; i++) {
                const x1 = curvePoints[i].x
                const y1 = curvePoints[i].y
                const x2 = curvePoints[i + 1].x
                const y2 = curvePoints[i + 1].y
                pathLength += Math.sqrt((x2 - x1) * (x2 - x1) + (y2 - y1) * (y2 - y1))
            }
            const glowLength = Math.max(pathLength * 0.2, 80)
            const gradientId = 'protein-glow-' + Date.now()
            
            const svg = '<svg width="' + width + '" height="' + height + '" viewBox="0 0 ' + width + ' ' + height + '" xmlns="http://www.w3.org/2000/svg">' +
                '<defs>' +
                '<linearGradient id="' + gradientId + '" x1="0%" y1="0%" x2="100%" y2="0%">' +
                '<stop offset="0%" stop-color="var(--primary-color)" stop-opacity="0" />' +
                '<stop offset="35%" stop-color="var(--primary-color)" stop-opacity="0.3" />' +
                '<stop offset="50%" stop-color="var(--primary-color)" stop-opacity="1" />' +
                '<stop offset="65%" stop-color="var(--primary-color)" stop-opacity="0.3" />' +
                '<stop offset="100%" stop-color="var(--primary-color)" stop-opacity="0" />' +
                '</linearGradient>' +
                '<filter id="glow-' + gradientId + '" x="-50%" y="-50%" width="200%" height="200%">' +
                '<feGaussianBlur stdDeviation="5" result="coloredBlur"/>' +
                '<feMerge>' +
                '<feMergeNode in="coloredBlur"/>' +
                '<feMergeNode in="SourceGraphic"/>' +
                '</feMerge>' +
                '</filter>' +
                '<filter id="glitch-protein-' + gradientId + '" x="-50%" y="-50%" width="200%" height="200%">' +
                '<feOffset in="SourceGraphic" dx="0" dy="0" result="offset1">' +
                '<animate attributeName="dx" values="0;-1;1;-1;0" dur="0.15s" repeatCount="indefinite"/>' +
                '</feOffset>' +
                '<feOffset in="SourceGraphic" dx="0" dy="0" result="offset2">' +
                '<animate attributeName="dx" values="0;1;-1;1;0" dur="0.2s" repeatCount="indefinite"/>' +
                '</feOffset>' +
                '<feComponentTransfer in="offset1" result="red">' +
                '<feFuncR type="discrete" tableValues="1 0 1 0"/>' +
                '</feComponentTransfer>' +
                '<feComponentTransfer in="offset2" result="cyan">' +
                '<feFuncG type="discrete" tableValues="0 1 0 1"/>' +
                '<feFuncB type="discrete" tableValues="1 0 1 0"/>' +
                '</feComponentTransfer>' +
                '<feMerge>' +
                '<feMergeNode in="red"/>' +
                '<feMergeNode in="cyan"/>' +
                '<feMergeNode in="SourceGraphic"/>' +
                '</feMerge>' +
                '</filter>' +
                '</defs>' +
                '<line x1="' + paddingLeft + '" y1="' + (height - paddingBottom) + '" x2="' + (width - paddingRight) + '" y2="' + (height - paddingBottom) + '" stroke="var(--border)" stroke-width="1" />' +
                '<line x1="' + paddingLeft + '" y1="' + paddingTop + '" x2="' + paddingLeft + '" y2="' + (height - paddingBottom) + '" stroke="var(--border)" stroke-width="1" />' +
                '<path d="' + pathD + '" fill="none" stroke="var(--primary-color)" stroke-width="2" opacity="0.3" />' +
                '<path d="' + pathD + '" fill="none" stroke="url(#' + gradientId + ')" stroke-width="5" filter="url(#glitch-protein-' + gradientId + ')" stroke-dasharray="' + glowLength + ' ' + pathLength + '" stroke-dashoffset="0" stroke-linecap="round">' +
                '<animate attributeName="stroke-dashoffset" from="0" to="' + (pathLength + glowLength) + '" dur="5s" repeatCount="indefinite" />' +
                '<animate attributeName="stroke-width" values="5;6;5;7;5" dur="0.3s" repeatCount="indefinite"/>' +
                '</path>' +
                circleParts.join('') +
                labelParts.join('') +
                '<text x="' + (paddingLeft - 10) + '" y="' + (paddingTop + 10) + '" text-anchor="end" font-size="12" fill="var(--text-secondary)">' + maxVal.toFixed(1) + ' %</text>' +
                '<text x="' + (paddingLeft - 10) + '" y="' + (height - paddingBottom) + '" text-anchor="end" font-size="12" fill="var(--text-secondary)">0 %</text>' +
                '</svg>'

            graph.innerHTML = svg
            container.style.display = 'block'
            
            setTimeout(() => {
                points.forEach((p, i) => {
                    const circleId = 'protein-circle-' + i
                    const circleEl = document.getElementById(circleId)
                    const tooltipEl = document.getElementById('tooltip-' + circleId)
                    if (!circleEl || !tooltipEl) return
                    
                    const circle = circleEl.querySelector('circle')
                    if (!circle) return
                    
                    circle.addEventListener('mouseenter', () => {
                        tooltipEl.style.opacity = '1'
                        circle.setAttribute('r', p.label === 'Albumin' ? 7 : 6)
                    })
                    
                    circle.addEventListener('mouseleave', () => {
                        tooltipEl.style.opacity = '0'
                        circle.setAttribute('r', p.label === 'Albumin' ? 5 : 4)
                    })
                })
            }, 50)
        }

        async function init() {
            loadSavedColor()
            await loadReferenceRanges()
            await loadAnalyses()
            await loadDrugs()
            await loadIntakeLogs()
            await loadDashboard()
            
            const skullStrip = document.getElementById('ascii-skeleton-strip')
            if (skullStrip) {
                skullStrip.innerHTML = renderAsciiSkull()
            }
            
            setTimeout(() => {
                startSparkAnimation()
            }, 500)
            
            if (currentCourse) {
                document.getElementById('course-title').value = currentCourse.title || ''
                document.getElementById('course-start').value = currentCourse.startDate?.split('T')[0] || ''
                document.getElementById('course-end').value = currentCourse.endDate?.split('T')[0] || ''
                document.getElementById('course-notes').value = currentCourse.notes || ''
            }
        }


        init()
    </script>
</body>
</html>
