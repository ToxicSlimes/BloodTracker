<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloodTracker</title>
    <meta name="google-client-id" content="118121261230-dtj72qp42r44mgpdbng83a1bju3oj87t.apps.googleusercontent.com">

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#00ff00">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- CSS bundle (Vite-built from 18 source files) -->
    <link rel="stylesheet" href="dist/css/style.css?v=20260213a">
</head>
<body class="crt">
<div class="flicker-overlay"></div>
<div class="vignette-overlay"></div>
<div class="noise-overlay"></div>
<div class="ascii-progress-bar" id="ascii-progress-bar">
    <div class="progress-bar-content">
        <div class="progress-bar-frame">
            <div class="progress-bar-fill" id="progress-bar-fill"></div>
            <div class="progress-bar-text" id="progress-bar-text">0%</div>
        </div>
    </div>
</div>
<div class="torch torch-left">
    <div class="torch-flame-container">
        <div class="torch-flame-ascii">⠀⠀⠀⠀⠀⠀⢱⣆⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠈⣿⣷⡀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢸⣿⣿⣷⣧⠀⠀⠀
⠀⠀⠀⠀⡀⢠⣿⡟⣿⣿⣿⡇⠀⠀
⠀⠀⠀⠀⣳⣼⣿⡏⢸⣿⣿⣿⢀⠀
⠀⠀⠀⣰⣿⣿⡿⠁⢸⣿⣿⡟⣼⡆
⢰⢀⣾⣿⣿⠟⠀⠀⣾⢿⣿⣿⣿⣿
⢸⣿⣿⣿⡏⠀⠀⠀⠃⠸⣿⣿⣿⡿
⢳⣿⣿⣿⠀⠀⠀⠀⠀⠀⢹⣿⡿⡁
⠀⠹⣿⣿⡄⠀⠀⠀⠀⠀⢠⣿⡞⠁
⠀⠀⠈⠛⢿⣄⠀⠀⠀⣠⠞⠋⠀⠀
⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⠀⠀⠀</div>
    </div>
    <div class="torch-holder-ascii">╔═══════════╗
║  ╔═╗╔═╗  ║
║  ║╬║║╬║  ║
╠══╬═╬═╬══╣
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
╚══╩═╩═╩══╝
   ║═══║
   ║═══║
   ║═══║
   ╚═══╝</div>
</div>
<div class="torch torch-right">
    <div class="torch-flame-container">
        <div class="torch-flame-ascii">⠀⠀⠀⠀⠀⠀⢱⣆⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠈⣿⣷⡀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⢸⣿⣿⣷⣧⠀⠀⠀
⠀⠀⠀⠀⡀⢠⣿⡟⣿⣿⣿⡇⠀⠀
⠀⠀⠀⠀⣳⣼⣿⡏⢸⣿⣿⣿⢀⠀
⠀⠀⠀⣰⣿⣿⡿⠁⢸⣿⣿⡟⣼⡆
⢰⢀⣾⣿⣿⠟⠀⠀⣾⢿⣿⣿⣿⣿
⢸⣿⣿⣿⡏⠀⠀⠀⠃⠸⣿⣿⣿⡿
⢳⣿⣿⣿⠀⠀⠀⠀⠀⠀⢹⣿⡿⡁
⠀⠹⣿⣿⡄⠀⠀⠀⠀⠀⢠⣿⡞⠁
⠀⠀⠈⠛⢿⣄⠀⠀⠀⣠⠞⠋⠀⠀
⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⠀⠀⠀</div>
    </div>
    <div class="torch-holder-ascii">╔═══════════╗
║  ╔═╗╔═╗  ║
║  ║╬║║╬║  ║
╠══╬═╬═╬══╣
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
║  ║▓▓▓▓▓║  ║
╚══╩═╩═╩══╝
   ║═══║
   ║═══║
   ║═══║
   ╚═══╝</div>
</div>
<!-- React root — App.tsx renders Navigation, Pages, Modals, etc. -->
<div id="app"></div>

<!-- Color Picker (vanilla JS — window.toggleColorPicker, setColor, setFont) -->
<div class="color-picker-container">
    <button class="color-picker-toggle" onclick="toggleColorPicker()">[ ЦВЕТ ]</button>
    <div class="color-picker-panel" id="color-picker-panel">
        <div class="color-presets">
            <div class="color-preset" style="background: #00ff00;" onclick="setColor('#00ff00')" title="Зеленый"></div>
            <div class="color-preset" style="background: #00ffff;" onclick="setColor('#00ffff')" title="Голубой"></div>
            <div class="color-preset" style="background: #ff00ff;" onclick="setColor('#ff00ff')" title="Пурпурный"></div>
            <div class="color-preset" style="background: #ffff00;" onclick="setColor('#ffff00')" title="Желтый"></div>
            <div class="color-preset" style="background: #ff6600;" onclick="setColor('#ff6600')" title="Оранжевый"></div>
            <div class="color-preset" style="background: #ff0066;" onclick="setColor('#ff0066')" title="Розовый"></div>
            <div class="color-preset" style="background: #00ff66;" onclick="setColor('#00ff66')" title="Лайм"></div>
            <div class="color-preset" style="background: #6600ff;" onclick="setColor('#6600ff')" title="Фиолетовый"></div>
        </div>
        <div class="color-custom">
            <input type="color" id="custom-color" value="#00ff00" onchange="setColor(this.value)">
            <input type="text" id="custom-color-text" value="#00ff00" placeholder="#00ff00" onchange="setColor(this.value)">
        </div>
        <div class="font-picker" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
            <div style="margin-bottom: 10px; font-size: 12px; color: var(--text-secondary);">ШРИФТ:</div>
            <div style="display: flex; gap: 8px;">
                <button class="font-preset" onclick="setFont('rotasuningr')" style="flex: 1; padding: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-primary); cursor: pointer; font-family: var(--ascii-font-family);">Rotasuningr</button>
                <button class="font-preset" onclick="setFont('ibm')" style="flex: 1; padding: 8px; background: transparent; border: 1px solid var(--border); color: var(--text-primary); cursor: pointer; font-family: var(--ascii-font-family);">IBM MDA</button>
            </div>
        </div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border);">
            <div style="margin-bottom: 10px; font-size: 12px; color: var(--text-secondary);">ASCII ЗАГОЛОВКИ:</div>
            <button id="asciify-toggle-btn" class="asciify-toggle active" onclick="window.asciify.toggle()">[ ASCII: ON ]</button>
        </div>
    </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="drug-modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="drug-modal-title">
        <div class="modal-header">
            <h2 id="drug-modal-title">[ ДОБАВИТЬ ПРЕПАРАТ ]</h2>
            <button class="modal-close" onclick="closeDrugModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group catalog-autocomplete">
                <label>Субстанция (из каталога)</label>
                <input type="text" id="drug-catalog-search" placeholder="Начните вводить название..." autocomplete="off">
                <input type="hidden" id="drug-catalog-id">
                <div class="catalog-dropdown" id="drug-catalog-dropdown"></div>
            </div>
            <div class="substance-info-panel" id="substance-info-panel">
                <div class="info-header">
                    <span class="info-title" id="substance-info-title"></span>
                    <button class="info-close" onclick="window.clearSubstanceInfo()">&times;</button>
                </div>
                <div id="substance-info-body"></div>
            </div>
            <div class="form-group">
                <label>Название препарата</label>
                <input type="text" id="drug-name" placeholder="Например: Тестостерон энантат">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Тип</label>
                    <select id="drug-type">
                        <option value="0">[ ОРАЛЬНЫЙ ]</option>
                        <option value="1">[ ИНЪЕКЦИОННЫЙ ]</option>
                        <option value="2">[ ПОДКОЖНЫЙ ]</option>
                        <option value="3">[ ТРАНСДЕРМАЛЬНЫЙ ]</option>
                        <option value="4">[ НАЗАЛЬНЫЙ ]</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Дозировка</label>
                    <input type="text" id="drug-dosage" placeholder="250мг/мл">
                </div>
            </div>
            <div class="form-group mfr-dropdown">
                <label>Производитель</label>
                <input type="text" id="drug-mfr-search" placeholder="Выберите производителя..." autocomplete="off">
                <input type="hidden" id="drug-mfr-id">
                <div class="mfr-dropdown-list" id="drug-mfr-dropdown"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Количество</label>
                    <input type="text" id="drug-amount" placeholder="10мл или 60 таб">
                </div>
                <div class="form-group">
                    <label>Схема приёма</label>
                    <input type="text" id="drug-schedule" placeholder="250мг E3D">
                </div>
            </div>
            <div class="form-group">
                <label>Заметки</label>
                <textarea id="drug-notes" rows="3" placeholder="Дополнительная информация..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDrugModal()">Отмена</button>
            <button class="btn" onclick="saveDrug()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="log-modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="log-modal-title">
        <div class="modal-header">
            <h2 id="log-modal-title">[ ДОБАВИТЬ ЗАПИСЬ ]</h2>
            <button class="modal-close" onclick="closeLogModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Дата</label>
                    <input type="date" id="log-date">
                </div>
                <div class="form-group">
                    <label>Препарат</label>
                    <select id="log-drug"></select>
                </div>
            </div>
            <div class="form-group">
                <label>Источник (покупка)</label>
                <select id="log-purchase">
                    <option value="">Авто</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Доза</label>
                    <input type="text" id="log-dose" placeholder="250мг">
                </div>
                <div class="form-group">
                    <label>Место / заметка</label>
                    <input type="text" id="log-note" placeholder="Дельта правая">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeLogModal()">Отмена</button>
            <button class="btn" onclick="saveLog()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="pdf-import-modal">
    <div class="modal">
        <div class="modal-header">
            <h2>[ ИМПОРТ АНАЛИЗА ИЗ PDF ]</h2>
            <button class="modal-close" onclick="closePdfImportModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>PDF файл с анализами (KDL, Инвитро, Гемотест и др.)</label>
                <input type="file" id="pdf-file" accept=".pdf" style="padding: 15px; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer;">
            </div>
            <div class="form-group">
                <label>Метка анализа (опционально)</label>
                <input type="text" id="pdf-label" placeholder="До курса / После курса / ПКТ">
            </div>
            <div id="pdf-import-status" style="display: none; margin-top: 15px; padding: 15px; border-radius: 8px;"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closePdfImportModal()">Отмена</button>
            <button class="btn" id="pdf-import-btn" onclick="importPdf()">[ ИМПОРТИРОВАТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="analysis-modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="analysis-modal-title">
        <div class="modal-header">
            <h2 id="analysis-modal-title">[ ДОБАВИТЬ АНАЛИЗ ]</h2>
            <button class="modal-close" onclick="closeAnalysisModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Дата анализа</label>
                    <input type="date" id="analysis-date">
                </div>
                <div class="form-group">
                    <label>Метка</label>
                    <input type="text" id="analysis-label" placeholder="До курса / После курса">
                </div>
                <div class="form-group">
                    <label>Лаборатория</label>
                    <input type="text" id="analysis-lab" placeholder="KDL, Инвитро...">
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="hormones">Гормоны</button>
                <button class="tab" data-tab="lipids">Липиды</button>
                <button class="tab" data-tab="liver">Печень</button>
                <button class="tab" data-tab="general">Общие</button>
            </div>

            <div class="tab-content active" id="tab-hormones">
                <div class="form-row">
                    <div class="form-group"><label>Тестостерон общий</label><input type="number" step="0.01" id="val-testosterone" placeholder="8.33-30.19"></div>
                    <div class="form-group"><label>Тестостерон свободный</label><input type="number" step="0.0001" id="val-free-testosterone" placeholder="0.22-0.77"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ЛГ</label><input type="number" step="0.01" id="val-lh" placeholder="0.57-12.07"></div>
                    <div class="form-group"><label>ФСГ</label><input type="number" step="0.01" id="val-fsh" placeholder="0.95-11.95"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Пролактин</label><input type="number" step="0.01" id="val-prolactin" placeholder="72.66-407.40"></div>
                    <div class="form-group"><label>Эстрадиол</label><input type="number" step="0.01" id="val-estradiol" placeholder="40-161"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ГСПГ</label><input type="number" step="0.01" id="val-shbg" placeholder="16.2-68.5"></div>
                    <div class="form-group"><label>ТТГ</label><input type="number" step="0.0001" id="val-tsh" placeholder="0.35-4.94"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-lipids">
                <div class="form-row">
                    <div class="form-group"><label>Холестерин общий</label><input type="number" step="0.01" id="val-cholesterol" placeholder="3.4-6.3"></div>
                    <div class="form-group"><label>ЛПВП / HDL</label><input type="number" step="0.01" id="val-hdl" placeholder=">1.03"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ЛПНП / LDL</label><input type="number" step="0.01" id="val-ldl" placeholder="<2.6"></div>
                    <div class="form-group"><label>Триглицериды</label><input type="number" step="0.01" id="val-triglycerides" placeholder="<1.7"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Коэфф. атерогенности</label><input type="number" step="0.1" id="val-atherogenic" placeholder="1.0-2.5"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-liver">
                <div class="form-row">
                    <div class="form-group"><label>АЛТ</label><input type="number" step="0.1" id="val-alt" placeholder="<50"></div>
                    <div class="form-group"><label>АСТ</label><input type="number" step="0.1" id="val-ast" placeholder="<50"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>ГГТ</label><input type="number" step="0.1" id="val-ggt" placeholder="<55"></div>
                    <div class="form-group"><label>Билирубин общий</label><input type="number" step="0.1" id="val-bilirubin" placeholder="5-21"></div>
                </div>
            </div>

            <div class="tab-content" id="tab-general">
                <div class="form-row">
                    <div class="form-group"><label>Гемоглобин</label><input type="number" step="0.1" id="val-hemoglobin" placeholder="130-170"></div>
                    <div class="form-group"><label>Гематокрит</label><input type="number" step="0.1" id="val-hematocrit" placeholder="39-49"></div>
                </div>
                <div class="form-row">
                    <div class="form-group"><label>Глюкоза</label><input type="number" step="0.01" id="val-glucose" placeholder="3.9-6.1"></div>
                    <div class="form-group"><label>Витамин D</label><input type="number" step="0.1" id="val-vitd" placeholder="30-100"></div>
                </div>
            </div>

            <div class="card" style="margin-top: 15px;">
                <div class="card-header">
                    <div class="card-title" data-asciify="md">[ ДОПОЛНИТЕЛЬНЫЕ ПОКАЗАТЕЛИ ]</div>
                    <button class="btn btn-secondary btn-small" onclick="addExtraRow()">[ + ДОБАВИТЬ ]</button>
                </div>
                <div id="extra-rows"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAnalysisModal()">Отмена</button>
            <button class="btn" onclick="saveAnalysis()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="workout-program-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="workout-program-modal-title">[ СОЗДАТЬ ПРОГРАММУ ]</h2>
            <button class="modal-close" onclick="window.closeWorkoutProgramModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Название программы</label>
                <input type="text" id="workout-program-title" placeholder="Например: Набор массы">
            </div>
            <div class="form-group">
                <label>Заметки</label>
                <textarea id="workout-program-notes" rows="3" placeholder="Описание программы, цели..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window.closeWorkoutProgramModal()">Отмена</button>
            <button class="btn" onclick="window.saveWorkoutProgram()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="workout-day-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="workout-day-modal-title">[ СОЗДАТЬ ДЕНЬ ]</h2>
            <button class="modal-close" onclick="window.closeWorkoutDayModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>День недели</label>
                <select id="workout-day-dayofweek">
                    <option value="1">Понедельник</option>
                    <option value="2">Вторник</option>
                    <option value="3">Среда</option>
                    <option value="4">Четверг</option>
                    <option value="5">Пятница</option>
                    <option value="6">Суббота</option>
                    <option value="0">Воскресенье</option>
                </select>
            </div>
            <div class="form-group">
                <label>Название (опционально)</label>
                <input type="text" id="workout-day-title" placeholder="Например: Грудь + трицепс">
            </div>
            <div class="form-group">
                <label>Заметки</label>
                <textarea id="workout-day-notes" rows="3" placeholder="Описание тренировочного дня..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window.closeWorkoutDayModal()">Отмена</button>
            <button class="btn" onclick="window.saveWorkoutDay()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="workout-exercise-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="workout-exercise-modal-title">[ СОЗДАТЬ УПРАЖНЕНИЕ ]</h2>
            <button class="modal-close" onclick="window.closeWorkoutExerciseModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Выбрать из каталога (опционально)</label>
                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                    <input type="text" id="exercise-catalog-search" placeholder="Поиск упражнения..." style="flex: 1;">
                    <select id="exercise-catalog-filter" style="width: 150px;">
                        <option value="">Все группы</option>
                        <option value="0">Все тело</option>
                        <option value="1">Грудь</option>
                        <option value="2">Спина</option>
                        <option value="3">Плечи</option>
                        <option value="4">Бицепс</option>
                        <option value="5">Трицепс</option>
                        <option value="6">Предплечья</option>
                        <option value="7">Пресс</option>
                        <option value="8">Ягодицы</option>
                        <option value="9">Квадрицепс</option>
                        <option value="10">Бицепс бедра</option>
                        <option value="11">Икры</option>
                    </select>
                </div>
                <div id="exercise-catalog-list" style="max-height: 250px; overflow-y: auto; border: 1px solid var(--border); padding: 8px; margin-bottom: 8px; background: var(--bg-secondary, rgba(0,0,0,0.2)); border-radius: 4px;"></div>
                <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">
                    💡 Если каталог пуст, добавьте упражнение вручную ниже
                </div>
            </div>
            <div class="form-group">
                <label>Название упражнения</label>
                <input type="text" id="workout-exercise-name" placeholder="Например: Жим лёжа">
            </div>
            <div class="form-group">
                <label>Группа мышц</label>
                <select id="workout-exercise-musclegroup">
                    <option value="0">Все тело</option>
                    <option value="1">Грудь</option>
                    <option value="2">Спина</option>
                    <option value="3">Плечи</option>
                    <option value="4">Бицепс</option>
                    <option value="5">Трицепс</option>
                    <option value="6">Предплечья</option>
                    <option value="7">Пресс</option>
                    <option value="8">Ягодицы</option>
                    <option value="9">Квадрицепс</option>
                    <option value="10">Бицепс бедра</option>
                    <option value="11">Икры</option>
                </select>
            </div>
            <div class="form-group">
                <label>Заметки</label>
                <textarea id="workout-exercise-notes" rows="3" placeholder="Техника выполнения, оборудование..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window.closeWorkoutExerciseModal()">Отмена</button>
            <button class="btn" onclick="window.saveWorkoutExercise()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="workout-set-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="workout-set-modal-title">[ СОЗДАТЬ ПОДХОД ]</h2>
            <button class="modal-close" onclick="window.closeWorkoutSetModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Повторения</label>
                    <input type="number" id="workout-set-repetitions" placeholder="12" min="1">
                </div>
                <div class="form-group">
                    <label>Вес (кг)</label>
                    <input type="number" id="workout-set-weight" placeholder="60" step="0.5" min="0">
                </div>
            </div>
            <div class="form-group">
                <label>Длительность (опционально)</label>
                <input type="text" id="workout-set-duration" placeholder="00:01:30 (ч:м:с)">
            </div>
            <div class="form-group">
                <label>Заметки</label>
                <textarea id="workout-set-notes" rows="2" placeholder="Дополнительная информация..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window.closeWorkoutSetModal()">Отмена</button>
            <button class="btn" onclick="window.saveWorkoutSet()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="purchase-modal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="purchase-modal-title">
        <div class="modal-header">
            <h2 id="purchase-modal-title">[ ДОБАВИТЬ ПОКУПКУ ]</h2>
            <button class="modal-close" onclick="window.purchaseModals.closePurchaseModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label>Препарат</label>
                    <select id="purchase-drug"></select>
                </div>
                <div class="form-group">
                    <label>Дата покупки</label>
                    <input type="date" id="purchase-date">
                </div>
            </div>
            <div class="form-group mfr-dropdown">
                <label>Производитель</label>
                <input type="text" id="purchase-mfr-search" placeholder="Выберите производителя..." autocomplete="off">
                <input type="hidden" id="purchase-mfr-id">
                <div class="mfr-dropdown-list" id="purchase-mfr-dropdown"></div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Количество (доз)</label>
                    <input type="number" id="purchase-quantity" placeholder="10" min="1">
                </div>
                <div class="form-group">
                    <label>Цена (₽)</label>
                    <input type="number" id="purchase-price" placeholder="2000" step="0.01" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Продавец / Аптека</label>
                    <input type="text" id="purchase-vendor" placeholder="Название аптеки или поставщика">
                </div>
            </div>
            <div class="form-group">
                <label>Заметки</label>
                <textarea id="purchase-notes" rows="3" placeholder="Дополнительная информация..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="window.purchaseModals.closePurchaseModal()">Отмена</button>
            <button class="btn" onclick="window.purchaseModals.savePurchase()">[ СОХРАНИТЬ ]</button>
        </div>
    </div>
</div>

<!-- Anti-reload-loop guard. Runs BEFORE any ES6 modules load. -->
<!-- Detects rapid reloads (401 → reload → 401 loop) and breaks the cycle. -->
<script>
(function() {
    var key = '_bt_rl', now = Date.now();
    var last = parseInt(sessionStorage.getItem(key) || '0');
    if (now - last < 3000) {
        // Rapid reload detected — break the loop by clearing stale tokens
        localStorage.removeItem('bt_token');
        localStorage.removeItem('bt_user');
        sessionStorage.removeItem(key);
        return;
    }
    sessionStorage.setItem(key, String(now));
    setTimeout(function() { sessionStorage.removeItem(key); }, 5000);
})();
</script>

<!-- Google Sign-In -->
<script>
    // Initialize Google Sign-In after GSI library loads
    window.initGoogleSignIn = function() {
        const clientId = document.querySelector('meta[name="google-client-id"]')?.content;
        if (clientId && window.google?.accounts?.id) {
            google.accounts.id.initialize({
                client_id: clientId,
                callback: window.handleGoogleCredential
            });
        }
    };
</script>
<script src="https://accounts.google.com/gsi/client" async defer onload="initGoogleSignIn()"></script>

<!-- ApexCharts -->
<!-- Research Modal -->
<div class="research-modal-overlay" id="research-modal-overlay">
    <div class="research-modal">
        <div class="research-modal-header">
            <span class="research-modal-title" id="research-modal-title">ИССЛЕДОВАНИЯ</span>
            <button class="research-modal-close" id="research-modal-close">[ X ]</button>
        </div>
        <div class="research-modal-body">
            <div class="research-tabs" id="research-tabs">
                <button class="research-tab active" data-tab="mechanism">МЕХАНИЗМ</button>
                <button class="research-tab" data-tab="studies">ИССЛЕДОВАНИЯ</button>
                <button class="research-tab" data-tab="bloodwork">АНАЛИЗЫ</button>
                <button class="research-tab" data-tab="interactions">ВЗАИМОДЕЙСТВИЯ</button>
                <button class="research-tab" data-tab="contra">ПРОТИВОПОКАЗАНИЯ</button>
                <button class="research-tab" data-tab="practical">ПРАКТИКА</button>
            </div>
            <div id="research-content"></div>
        </div>
    </div>
</div>

<!-- Add Exercise to Session Modal — migrated to React (ActiveWorkoutTab.tsx) -->

<!-- WorkoutMiniBar, RestTimer, QuickSetLogger — now React components -->

<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.1/dist/apexcharts.min.js"></script>

<!-- JavaScript Module -->
<script type="module" src="dist/js/main.js?v=20260213b"></script>
</body>
</html>
