# ADR-0002: LiteDB + Per-User Isolation

**Статус:** Принято  
**Дата:** 2025

## Контекст

Нужна БД для десктопного приложения с multi-user поддержкой (после добавления auth).

## Решение

**LiteDB 5.0.21** — embedded NoSQL, один `.db` файл на пользователя.

## Почему LiteDB

- **Zero setup** — не нужен сервер БД, один файл = вся база
- **BSON** — нативно хранит Dictionary, List без ORM
- **Идеален для Electron** — файл лежит рядом с приложением
- **Бэкап** — просто скопировать файл
- **Нет миграций** — схема определяется C# классами

## Почему Per-User Isolation

- **Безопасность** — пользователь физически не может прочитать чужие данные
- **Простота** — не нужны фильтры `WHERE userId = X` в каждом запросе
- **Бэкап** — можно бэкапить/удалять данные одного пользователя
- **Миграция** — `DataMigrationService` конвертирует legacy single-user DB → per-user при старте

## Реализация

```
IUserContext.UserId → BloodTrackerDbContext → Filename=data/{userId}.db
```

Каждый scoped `BloodTrackerDbContext` открывает файл текущего пользователя.

## Последствия

- Нет cross-user запросов (агрегатная аналитика невозможна)
- Нет транзакций между коллекциями (ограничение LiteDB)
- При большом количестве пользователей — много файлов на диске
